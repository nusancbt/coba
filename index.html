<!DOCTYPE html>
<html lang="id" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Siswa & LMS Terintegrasi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Konfigurasi Tailwind untuk Dark Mode menggunakan 'class'
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar-transition { transition: transform 0.3s ease-in-out; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .dark .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .playlist-scroll::-webkit-scrollbar { width: 6px; }
        .playlist-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .dark .playlist-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .playlist-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark .playlist-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .playlist-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .iframe-container { position: relative; width: 100%; height: 100%; overflow: hidden; background-color: white; }
        .dark .iframe-container { background-color: #0f172a; }
        iframe { width: 100%; height: 100%; border: none; }
        .nav-item.active { background-color: #2563eb; color: white; }
        .nav-item.active i { color: white; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; z-index: 10; }
        .dark .loader { border: 4px solid #1e293b; border-top: 4px solid #3b82f6; }
        @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px); }
        .tab-btn.active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: 600; background-color: #eff6ff; }
        .dark .tab-btn.active { background-color: rgba(30, 58, 138, 0.3); color: #60a5fa; }
        .tab-btn { color: #6b7280; font-weight: 500; transition: all 0.2s; }
        .dark .tab-btn { color: #9ca3af; }
        .tab-btn:hover { background-color: #f9fafb; }
        .dark .tab-btn:hover { background-color: #1e293b; }
        .playlist-item { transition: all 0.2s; border-left: 3px solid transparent; }
        .playlist-item:hover { background-color: #f8fafc; }
        .dark .playlist-item:hover { background-color: #1e293b; }
        .playlist-item.active { background-color: #eff6ff; border-left-color: #2563eb; }
        .dark .playlist-item.active { background-color: rgba(30, 58, 138, 0.3); border-left-color: #3b82f6; }
        .playlist-item.active .title { color: #1d4ed8; font-weight: 600; }
        .dark .playlist-item.active .title { color: #60a5fa; }
        .playlist-item.active .icon-play { opacity: 1; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Task Styles */
        .task-item.completed .task-title { text-decoration: line-through; color: #9ca3af; }
        .dark .task-item.completed .task-title { color: #4b5563; }
        .task-item { transition: all 0.2s ease; }
        .task-item:hover { transform: translateY(-2px); }
        
        /* Calculator Styles */
        .calc-btn { transition: all 0.1s; }
        .calc-btn:active { transform: scale(0.95); }

        /* Setup Dark Mode Input Autocomplete Bug Fix */
        .dark input:-webkit-autofill,
        .dark input:-webkit-autofill:hover, 
        .dark input:-webkit-autofill:focus, 
        .dark input:-webkit-autofill:active{
            -webkit-box-shadow: 0 0 0 30px #334155 inset !important;
            -webkit-text-fill-color: white !important;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-slate-900 h-screen overflow-hidden flex text-gray-800 dark:text-gray-200 transition-colors duration-300">

    <!-- Loading Screen -->
    <div id="app-loading" class="fixed inset-0 z-[60] bg-white dark:bg-slate-900 flex flex-col items-center justify-center transition-colors duration-300">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600 mb-4"></div>
        <p class="text-gray-600 dark:text-gray-400 font-medium">Loading...</p>
    </div>

    <!-- Mobile Overlay -->
    <div id="mobile-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black opacity-50 z-20 hidden lg:hidden"></div>

    <!-- Calculator Modal (Floating) -->
    <div id="calculator-modal" class="fixed bottom-20 right-4 z-50 hidden animate-fade-in">
        <div class="bg-slate-900 dark:bg-slate-950 p-4 rounded-2xl shadow-2xl w-64 border border-slate-700">
            <div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-2">
                <span class="text-white text-xs font-bold tracking-wider">KALKULATOR</span>
                <button onclick="toggleCalculator()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <input type="text" id="calc-display" readonly class="w-full bg-slate-800 dark:bg-slate-900 text-white text-right text-2xl p-3 rounded-lg mb-3 font-mono outline-none border border-slate-700" value="0">
            <div class="grid grid-cols-4 gap-2">
                <button onclick="calcClear()" class="calc-btn col-span-2 bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg font-bold">AC</button>
                <button onclick="calcAppend('/')" class="calc-btn bg-slate-700 hover:bg-slate-600 text-white p-2 rounded-lg font-bold">√∑</button>
                <button onclick="calcAppend('*')" class="calc-btn bg-slate-700 hover:bg-slate-600 text-white p-2 rounded-lg font-bold">√ó</button>
                
                <button onclick="calcAppend('7')" class="calc-btn bg-slate-800 hover:bg-slate-700 text-white p-2 rounded-lg font-bold">7</button>
                <button onclick="calcAppend('8')" class="calc-btn bg-slate-800 hover:bg-slate-700 text-white p-2 rounded-lg font-bold">8</button>
                <button onclick="calcAppend('9')" class="calc-btn bg-slate-800 hover:bg-slate-700 text-white p-2 rounded-lg font-bold">9</button>
                <button onclick="calcAppend('-')" class="calc-btn bg-slate-700 hover:bg-slate-600 text-white p-2 rounded-lg font-bold">-</button>
                
                <button onclick="calcAppend('4')" class="calc-btn bg-slate-800 hover:bg-slate-700 text-white p-2 rounded-lg font-bold">4</button>
                <button onclick="calcAppend('5')" class="calc-btn bg-slate-800 hover:bg-slate-700 text-white p-2 rounded-lg font-bold">5</button>
                <button onclick="calcAppend('6')" class="calc-btn bg-slate-800 hover:bg-slate-700 text-white p-2 rounded-lg font-bold">6</button>
                <button onclick="calcAppend('+')" class="calc-btn bg-slate-700 hover:bg-slate-600 text-white p-2 rounded-lg font-bold">+</button>
                
                <button onclick="calcAppend('1')" class="calc-btn bg-slate-800 hover:bg-slate-700 text-white p-2 rounded-lg font-bold">1</button>
                <button onclick="calcAppend('2')" class="calc-btn bg-slate-800 hover:bg-slate-700 text-white p-2 rounded-lg font-bold">2</button>
                <button onclick="calcAppend('3')" class="calc-btn bg-slate-800 hover:bg-slate-700 text-white p-2 rounded-lg font-bold">3</button>
                <button onclick="calcResult()" class="calc-btn row-span-2 bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-lg font-bold">=</button>
                
                <button onclick="calcAppend('0')" class="calc-btn col-span-2 bg-slate-800 hover:bg-slate-700 text-white p-2 rounded-lg font-bold">0</button>
                <button onclick="calcAppend('.')" class="calc-btn bg-slate-800 hover:bg-slate-700 text-white p-2 rounded-lg font-bold">.</button>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="password-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-overlay">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-sm mx-4 animate-fade-in border dark:border-slate-700">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900/40 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600 dark:text-blue-400">
                    <i class="fa-solid fa-lock text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 dark:text-white">Akses Terbatas</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Masukkan password admin/guru.</p>
            </div>
            <form onsubmit="verifyPassword(event)">
                <input type="hidden" id="auth-target" value="settings">
                <div class="mb-4">
                    <input type="password" id="admin-password" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none text-center tracking-widest text-lg" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <div class="flex gap-3">
                    <button type="button" onclick="closePasswordModal()" class="flex-1 px-4 py-2 bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-slate-600">Batal</button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-lg shadow-blue-500/30">Masuk</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Rename Modal -->
    <div id="rename-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-overlay">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-sm mx-4 animate-fade-in border dark:border-slate-700">
            <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4">Ubah Nama File</h3>
            <form onsubmit="handleRenameFile(event)">
                <input type="hidden" id="rename-file-id">
                <div class="mb-4">
                    <input type="text" id="rename-file-name" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none" required>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">*Ekstensi .pdf akan ditambahkan otomatis</p>
                </div>
                <div class="flex gap-3">
                    <button type="button" onclick="closeRenameModal()" class="flex-1 px-4 py-2 bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-gray-300 rounded-lg">Batal</button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- PDF Viewer Modal -->
    <div id="pdf-viewer-modal" class="hidden fixed inset-0 z-50 overflow-hidden">
        <div class="absolute inset-0 bg-slate-900 bg-opacity-90 backdrop-blur-sm" onclick="closePreview()"></div>
        <div class="absolute inset-4 md:inset-10 flex flex-col bg-white dark:bg-slate-800 rounded-xl shadow-2xl overflow-hidden animate-fade-in">
            <div class="flex justify-between items-center p-4 border-b dark:border-slate-700 bg-gray-50 dark:bg-slate-900">
                <h3 id="preview-title" class="font-bold truncate pr-4 text-gray-700 dark:text-gray-200">Preview Materi</h3>
                <button onclick="closePreview()" class="text-red-500 hover:text-red-700 bg-red-100 dark:bg-red-900/30 hover:bg-red-200 dark:hover:bg-red-900/50 rounded-full w-8 h-8 flex items-center justify-center transition-colors">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <iframe id="preview-frame" class="flex-grow w-full h-full bg-slate-100 dark:bg-slate-900"></iframe>
        </div>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar" class="bg-slate-900 text-slate-300 w-64 flex-shrink-0 fixed inset-y-0 left-0 z-30 transform -translate-x-full lg:relative lg:translate-x-0 sidebar-transition flex flex-col h-full shadow-xl">
        <div class="h-16 flex items-center justify-center border-b border-slate-700 bg-slate-900 shadow-sm">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-1.5 rounded-lg">
                    <i class="fa-solid fa-graduation-cap text-xl"></i>
                </div>
                <h1 id="sidebar-app-name" class="text-xl font-bold text-white tracking-wide">NusanCBT</h1>
            </div>
        </div>
        <div class="p-4 border-b border-slate-700 bg-slate-800/50">
            <div class="flex items-center gap-3 mb-3">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" alt="User Avatar" class="w-10 h-10 rounded-full bg-slate-600 border-2 border-slate-500">
                <div>
                    <p class="text-sm font-semibold text-white">Siswa Peserta</p>
                    <p id="sidebar-app-subtitle" class="text-xs text-slate-400">Loading...</p>
                </div>
            </div>
        </div>
        <nav class="flex-1 overflow-y-auto custom-scrollbar p-3 space-y-1">
            <div class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 mt-2 px-3">Menu Utama</div>
            <button onclick="switchView('home')" id="btn-home" class="nav-item w-full flex items-center gap-3 px-3 py-3 rounded-lg hover:bg-slate-800 transition-colors active">
                <i class="fa-solid fa-house w-5 text-center text-slate-400 transition-colors"></i>
                <span class="text-sm font-medium">Dashboard</span>
            </button>
            
            <!-- Dynamic Menu Placeholder -->
            <div id="sidebar-dynamic-menu"></div>
            
            <!-- LMS MENU ITEM (Hidden by default based on settings) -->
            <button onclick="switchView('lms')" id="btn-lms" class="nav-item w-full flex items-center gap-3 px-3 py-3 rounded-lg hover:bg-slate-800 transition-colors">
                <i class="fa-solid fa-book-open w-5 text-center text-slate-400 transition-colors"></i>
                <span class="text-sm font-medium">E-Library (LMS)</span>
            </button>

            <!-- CBT MENU ITEM (NEW) -->
            <button onclick="switchView('cbt')" id="btn-cbt" class="nav-item w-full flex items-center gap-3 px-3 py-3 rounded-lg hover:bg-slate-800 transition-colors">
                <i class="fa-solid fa-laptop-code w-5 text-center text-slate-400 transition-colors"></i>
                <span class="text-sm font-medium">Portal Ujian (CBT)</span>
            </button>

            <!-- TASKS MENU ITEM (NEW) -->
            <button onclick="switchView('tasks')" id="btn-tasks" class="nav-item w-full flex items-center gap-3 px-3 py-3 rounded-lg hover:bg-slate-800 transition-colors">
                <i class="fa-solid fa-list-check w-5 text-center text-slate-400 transition-colors"></i>
                <span class="text-sm font-medium">Agenda & Tugas</span>
            </button>

            <div class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 mt-6 px-3">Lainnya</div>
            <button onclick="switchView('settings')" id="btn-settings" class="nav-item w-full flex items-center gap-3 px-3 py-3 rounded-lg hover:bg-slate-800 transition-colors">
                <i class="fa-solid fa-gear w-5 text-center text-slate-400 transition-colors"></i>
                <span class="text-sm font-medium">Pengaturan Admin</span>
            </button>     
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full relative w-full bg-gray-50 dark:bg-slate-900 transition-colors duration-300">
        <!-- Header -->
        <header class="h-16 bg-white dark:bg-slate-800 border-b border-gray-200 dark:border-slate-700 flex items-center justify-between px-4 lg:px-6 shadow-sm z-10 transition-colors duration-300">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="lg:hidden p-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-md">
                    <i class="fa-solid fa-bars text-xl"></i>
                </button>
                <h2 id="page-title" class="text-lg font-bold text-gray-800 dark:text-white">Dashboard Utama</h2>
            </div>
            <div class="flex items-center gap-4">
                <!-- Theme Toggle -->
                <button onclick="toggleDarkMode()" id="theme-toggle" class="p-2 text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-slate-700 rounded-full transition-colors" title="Ubah Tema">
                    <i id="theme-icon" class="fa-solid fa-moon"></i>
                </button>

                <!-- Calculator Toggle -->
                <button onclick="toggleCalculator()" class="hidden md:flex items-center gap-2 px-3 py-1.5 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 rounded-full text-xs font-bold hover:bg-slate-200 dark:hover:bg-slate-600 transition">
                    <i class="fa-solid fa-calculator"></i> Hitung
                </button>

                <div class="hidden md:flex flex-col items-end mr-2">
                    <span id="digital-clock" class="text-sm font-mono font-bold text-blue-600 dark:text-blue-400">00:00:00</span>
                    <span id="current-date" class="text-xs text-gray-500 dark:text-gray-400">Senin, 1 Jan 2024</span>
                </div>
                <button onclick="toggleFullscreen()" class="p-2 text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-slate-700 rounded-full" title="Layar Penuh"><i id="fullscreen-icon" class="fa-solid fa-expand"></i></button>
            </div>
        </header>

        <!-- RUNNING TEXT / MARQUEE -->
        <div id="marquee-container" class="bg-blue-600 dark:bg-blue-800 text-white text-sm py-1.5 overflow-hidden whitespace-nowrap hidden transition-colors duration-300">
            <div id="marquee-text" class="inline-block animate-marquee pl-[100%]">
                <!-- Text will be injected here -->
            </div>
        </div>
        <style>
            @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
            .animate-marquee { animation: marquee 20s linear infinite; }
        </style>

        <!-- Content Area -->
        <div id="content-area" class="flex-1 p-0 overflow-hidden relative">
            <div id="loader" class="loader"></div>

            <!-- 1. HOME VIEW -->
            <div id="view-home" class="h-full overflow-y-auto p-4 lg:p-6 animate-fade-in custom-scrollbar">
                
                <!-- Welcome Banner (New) -->
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 dark:from-blue-800 dark:to-indigo-800 rounded-2xl p-6 text-white mb-6 shadow-lg relative overflow-hidden transition-colors">
                    <div class="relative z-10">
                        <h2 class="text-2xl font-bold mb-1">Selamat Datang.! üëã</h2>
                        <p class="text-blue-100 dark:text-blue-200 text-sm mb-4">Akses materi, kerjakan tugas, dan pantau jadwal pelajaranmu hari ini.</p>
                        <div class="flex gap-3">
                            <button onclick="switchView('tasks')" class="px-4 py-2 bg-white text-blue-600 dark:text-blue-800 rounded-lg text-sm font-bold shadow-md hover:bg-blue-50 transition"><i class="fa-solid fa-list-check mr-2"></i>Cek Tugas</button>
                            <button onclick="switchView('lms')" class="px-4 py-2 bg-blue-700/50 text-white rounded-lg text-sm font-bold hover:bg-blue-700/70 transition backdrop-blur-sm"><i class="fa-solid fa-book-open mr-2"></i>Buka Pustaka</button>
                        </div>
                    </div>
                    <div class="absolute right-0 bottom-0 opacity-10 transform translate-x-10 translate-y-10">
                        <i class="fa-solid fa-graduation-cap text-9xl"></i>
                    </div>
                </div>

                <div id="curfew-banner" class="hidden mb-6 bg-yellow-50 dark:bg-yellow-900/30 border-l-4 border-yellow-500 p-4 rounded-r shadow-sm transition-all duration-300">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 text-yellow-500"><i class="fa-solid fa-clock text-2xl"></i></div>
                        <div class="ml-3">
                            <h3 class="text-sm font-bold text-yellow-800 dark:text-yellow-400">Info Akses Menu</h3>
                            <p class="text-sm text-yellow-700 dark:text-yellow-500 mt-1">Beberapa menu belum dibuka atau jadwal telah berakhir.</p>
                        </div>
                    </div>
                </div>

                <div id="home-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-6"></div>
                
                <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 p-6 transition-colors">
                    <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4 border-b dark:border-slate-700 pb-2 flex justify-between items-center">
                        Pengumuman Sekolah <span class="text-xs font-normal text-gray-500 dark:text-gray-300 bg-gray-100 dark:bg-slate-700 px-2 py-1 rounded">Terbaru</span>
                    </h3>
                    <div id="announcement-list" class="space-y-4"></div>
                </div>
            </div>

            <!-- 2. PLAYER WRAPPER -->
            <div id="view-iframe-wrapper" class="hidden w-full h-full bg-white dark:bg-slate-900 flex flex-col md:flex-row relative transition-colors">
                <div id="video-container" class="relative flex-1 bg-black h-[50vh] md:h-full transition-all duration-300">
                    <iframe id="main-iframe" class="w-full h-full bg-white dark:bg-slate-900" src="" allowfullscreen></iframe>
                    <button id="playlist-toggle-btn" onclick="togglePlaylist()" class="hidden absolute top-4 right-4 z-20 bg-black/70 hover:bg-blue-600 text-white px-3 py-2 rounded-md shadow-lg border border-white/20 backdrop-blur-sm transition-all text-xs flex items-center gap-2 group">
                        <i id="playlist-toggle-icon" class="fa-solid fa-list"></i>
                        <span class="hidden group-hover:inline font-medium">Daftar Materi</span>
                    </button>
                    
                    <!-- 404 Error -->
                    <div id="iframe-error" class="hidden absolute inset-0 flex flex-col items-center justify-center bg-white dark:bg-slate-900 p-8 text-center z-10 transition-colors">
                        <div class="w-24 h-24 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mb-6 animate-fade-in">
                            <i id="error-icon" class="fa-solid fa-link-slash text-4xl text-red-500"></i>
                        </div>
                        <h3 id="error-title" class="text-2xl font-bold text-gray-800 dark:text-white mb-2">Halaman Tidak Ditemukan (404)</h3>
                        <p id="error-message" class="text-gray-500 dark:text-gray-400 mb-8 max-w-md">URL materi atau menu yang Anda tuju tidak valid atau tidak dapat diakses.</p>
                        
                        <div class="flex gap-3">
                            <button onclick="switchView('home')" class="px-6 py-2.5 bg-gray-100 dark:bg-slate-800 hover:bg-gray-200 dark:hover:bg-slate-700 text-gray-700 dark:text-gray-300 rounded-lg font-medium transition-colors">
                                <i class="fa-solid fa-arrow-left mr-2"></i> Kembali ke Dashboard
                            </button>
                            <a id="external-link" href="#" target="_blank" class="px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors shadow-lg shadow-blue-500/30">
                                <i class="fa-solid fa-external-link-alt mr-2"></i> Buka di Tab Baru
                            </a>
                        </div>
                    </div>

                </div>
                <div id="playlist-sidebar" class="hidden w-full md:w-80 h-[50vh] md:h-full bg-white dark:bg-slate-800 border-l border-gray-200 dark:border-slate-700 flex flex-col shadow-xl z-10 transition-all duration-300">
                    <div class="p-3 border-b border-gray-200 dark:border-slate-700 bg-gray-50 dark:bg-slate-900 flex justify-between items-center transition-colors">
                        <h3 class="font-bold text-gray-700 dark:text-gray-200 text-sm flex items-center"><i class="fa-solid fa-list-ul mr-2 text-blue-600 dark:text-blue-400"></i> Materi Pembelajaran</h3>
                        <div class="flex items-center gap-2"><span id="playlist-counter" class="text-[10px] bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-400 px-2 py-0.5 rounded-full font-bold">0/0</span><button onclick="togglePlaylist()" class="text-gray-400 hover:text-red-500 md:hidden"><i class="fa-solid fa-xmark"></i></button></div>
                    </div>
                    <div id="playlist-items" class="flex-1 overflow-y-auto playlist-scroll p-0 bg-white dark:bg-slate-800 transition-colors"></div>
                </div>
            </div>

            <!-- 3. NEW LMS VIEW (Student View) -->
            <div id="view-lms" class="hidden h-full overflow-y-auto p-4 lg:p-6 custom-scrollbar animate-fade-in">
                <div class="max-w-7xl mx-auto pb-10">
                    <div class="flex justify-between items-center mb-6 bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 transition-colors">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800 dark:text-white">üìö Perpustakaan Digital</h2>
                            <p class="text-slate-500 dark:text-slate-400 text-sm">Akses materi PDF dan E-Book sekolah.</p>
                        </div>
                    </div>

                    <div id="lms-view-student" class="space-y-6">
                        <div id="lms-filter-container" class="flex flex-wrap gap-2 mb-4">
                            <!-- Populated by JS -->
                        </div>
                        <div id="lms-loading" class="hidden text-center py-10">
                            <div class="animate-spin inline-block w-8 h-8 border-[3px] border-current border-t-transparent text-blue-600 dark:text-blue-400 rounded-full" role="status" aria-label="loading"></div>
                            <p class="mt-2 text-slate-500 dark:text-slate-400 text-sm">Sedang memuat materi dari Google Drive...</p>
                        </div>
                        <div id="lms-file-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. NEW TASKS VIEW (Student Planner) -->
            <div id="view-tasks" class="hidden h-full overflow-y-auto p-4 lg:p-6 custom-scrollbar animate-fade-in">
                <div class="max-w-5xl mx-auto">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Input Section -->
                        <div class="lg:col-span-1">
                            <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md border border-slate-200 dark:border-slate-700 sticky top-4 transition-colors">
                                <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2"><i class="fa-solid fa-pen-to-square text-blue-600 dark:text-blue-400"></i> Catat Tugas Baru</h3>
                                <form onsubmit="handleAddTask(event)">
                                    <div class="mb-3">
                                        <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Mata Pelajaran</label>
                                        <select id="task-subject" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-colors">
                                            <option value="Umum">Umum</option>
                                            <option value="Matematika">Matematika</option>
                                            <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                                            <option value="Bahasa Inggris">Bahasa Inggris</option>
                                            <option value="IPA/Sains">IPA/Sains</option>
                                            <option value="Kejuruan">Produktif/Kejuruan</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Judul Tugas</label>
                                        <input type="text" id="task-title" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-colors" placeholder="Cth: PR Halaman 52" required>
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Deadline</label>
                                        <input type="date" id="task-date" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-colors" required>
                                    </div>
                                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-bold transition-colors shadow-lg"><i class="fa-solid fa-plus mr-1"></i> Tambah ke Agenda</button>
                                </form>
                                <div class="mt-6 pt-4 border-t border-gray-100 dark:border-slate-700">
                                    <h4 class="text-xs font-bold text-gray-400 uppercase mb-2">Statistik Tugas</h4>
                                    <div class="flex justify-between text-sm mb-1 text-gray-600 dark:text-gray-300"><span>Selesai</span> <span id="stat-completed" class="font-bold text-green-600 dark:text-green-400">0</span></div>
                                    <div class="flex justify-between text-sm text-gray-600 dark:text-gray-300"><span>Belum Selesai</span> <span id="stat-pending" class="font-bold text-orange-500 dark:text-orange-400">0</span></div>
                                </div>
                            </div>
                        </div>

                        <!-- List Section -->
                        <div class="lg:col-span-2 space-y-4">
                            <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 flex justify-between items-center transition-colors">
                                <h3 class="font-bold text-slate-800 dark:text-white">Daftar Agenda & PR</h3>
                                <button onclick="clearCompletedTasks()" class="text-xs text-red-500 hover:text-red-700 dark:hover:text-red-400 font-medium">Hapus yang selesai</button>
                            </div>
                            <div id="task-list-container" class="space-y-3">
                                <!-- Tasks rendered here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NEW CBT VIEW (Student View) -->
            <div id="view-cbt" class="hidden h-full overflow-y-auto p-4 lg:p-6 custom-scrollbar animate-fade-in">
                <div class="max-w-7xl mx-auto pb-10">
                    <div class="flex justify-between items-center mb-6 bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 transition-colors">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800 dark:text-white">üñ•Ô∏è Portal Ujian (CBT)</h2>
                            <p class="text-slate-500 dark:text-slate-400 text-sm">Kerjakan ujian, kuis, dan penilaian yang sedang berlangsung.</p>
                        </div>
                    </div>
                    
                    <div id="cbt-filter-container" class="flex flex-wrap gap-2 mb-4">
                        <!-- Populated by JS -->
                    </div>

                    <div id="cbt-exam-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- 5. SETTINGS VIEW -->
            <div id="view-settings" class="hidden h-full overflow-y-auto p-4 lg:p-6 custom-scrollbar">
                <div class="max-w-7xl mx-auto pb-10">
                    <div class="flex border-b border-gray-200 dark:border-slate-700 mb-6 bg-white dark:bg-slate-800 rounded-t-xl px-2 pt-2 shadow-sm overflow-x-auto transition-colors">
                        <button onclick="switchSettingsTab('lms')" id="tab-btn-lms" class="tab-btn active px-6 py-3 mr-2 focus:outline-none rounded-t-lg whitespace-nowrap"><i class="fa-solid fa-graduation-cap mr-2"></i> Manajemen Dashboard</button>
                        <button onclick="switchSettingsTab('lms-admin')" id="tab-btn-lms-admin" class="tab-btn px-6 py-3 mr-2 focus:outline-none rounded-t-lg whitespace-nowrap text-blue-600 dark:text-blue-400"><i class="fa-solid fa-book mr-2"></i> E-Library (Guru)</button>
                        <button onclick="switchSettingsTab('cbt')" id="tab-btn-cbt" class="tab-btn px-6 py-3 mr-2 focus:outline-none rounded-t-lg whitespace-nowrap text-purple-600 dark:text-purple-400"><i class="fa-solid fa-laptop-code mr-2"></i> Manajemen Ujian</button>
                        <button onclick="switchSettingsTab('menu')" id="tab-btn-menu" class="tab-btn px-6 py-3 mr-2 focus:outline-none rounded-t-lg whitespace-nowrap"><i class="fa-solid fa-list-check mr-2"></i> Menu Dasar</button>
                        <button onclick="switchSettingsTab('announcement')" id="tab-btn-announcement" class="tab-btn px-6 py-3 mr-2 focus:outline-none rounded-t-lg whitespace-nowrap"><i class="fa-solid fa-bullhorn mr-2"></i> Pengumuman</button>
                        <button onclick="switchSettingsTab('app')" id="tab-btn-app" class="tab-btn px-6 py-3 mr-2 focus:outline-none rounded-t-lg whitespace-nowrap"><i class="fa-solid fa-shield-halved mr-2"></i> Identitas & Keamanan</button>
                    </div>

                     <!-- TAB DASHBOARD LMS CONTENT -->
                     <div id="tab-content-lms" class="space-y-6 animate-fade-in">
                        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md p-6 border border-gray-200 dark:border-slate-700 transition-colors">
                            <div class="flex justify-between items-center mb-4 border-b dark:border-slate-700 pb-4">
                                <div><h3 class="text-lg font-bold text-gray-800 dark:text-white">Tambah Materi Dashboard</h3><p class="text-sm text-gray-500 dark:text-gray-400">Materi ini tampil di Home Dashboard (Video/Link).</p></div>
                                <button onclick="resetLMSForm()" class="text-sm text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 flex items-center bg-gray-100 dark:bg-slate-700 px-3 py-1 rounded-md transition-colors"><i class="fa-solid fa-rotate-left mr-2"></i> Reset Form</button>
                            </div>
                            <form onsubmit="saveLMS(event)" class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <input type="hidden" id="lms-edit-id">
                                <div class="col-span-1"><label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1.5">Mata Pelajaran <span class="text-red-500">*</span></label><div class="relative"><i class="fa-solid fa-book absolute left-3 top-3.5 text-gray-400"></i><input type="text" id="lms-subject" list="subject-suggestions" class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none transition-shadow" placeholder="Cth: Matematika" required><datalist id="subject-suggestions"><option value="Matematika"><option value="Bahasa Indonesia"><option value="Bahasa Inggris"><option value="IPA / Sains"><option value="Produktif TJKT"></datalist></div></div>
                                <div class="col-span-1"><label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1.5">Judul Materi / Topik <span class="text-red-500">*</span></label><input type="text" id="lms-topic" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none transition-shadow" placeholder="Cth: Aljabar Linear" required></div>
                                <div class="md:col-span-2"><label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1.5">Link Sumber Belajar <span class="text-red-500">*</span></label><div class="relative"><i class="fa-solid fa-link absolute left-3 top-3.5 text-gray-400"></i><input type="text" id="lms-url" class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none transition-shadow" placeholder="URL Youtube, PDF..." required></div></div>
                                <div><label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1.5">Tipe Materi</label><select id="lms-type" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none"><option value="video">Video Pembelajaran</option><option value="ebook">E-Book / PDF</option><option value="exam">Ujian Online</option><option value="zoom">Meeting / Zoom</option></select></div>
                                <div><label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1.5">Nama Guru</label><input type="text" id="lms-teacher" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Cth: Bpk. Budi"></div>
                                <div class="md:col-span-2 border dark:border-slate-600 rounded-lg p-4 bg-gray-50 dark:bg-slate-800/50"><div class="flex items-center justify-between cursor-pointer" onclick="document.getElementById('lms-advanced').classList.toggle('hidden');"><span class="text-sm font-bold text-gray-700 dark:text-gray-300"><i class="fa-solid fa-clock mr-2"></i> Penjadwalan & Warna</span><i class="fa-solid fa-chevron-down text-gray-400"></i></div><div id="lms-advanced" class="hidden mt-4 grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Jam Buka</label><input type="time" id="lms-auto-open" class="w-full px-3 py-2 rounded border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white text-sm"></div><div><label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Jam Tutup</label><input type="time" id="lms-auto-close" class="w-full px-3 py-2 rounded border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white text-sm"></div><div><label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Status</label><select id="lms-status" class="w-full px-3 py-2 rounded border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white text-sm"><option value="active">Terbit (Aktif)</option><option value="inactive">Draf</option></select></div><div><label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Warna</label><select id="lms-color" class="w-full px-3 py-2 rounded border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white text-sm"><option value="auto">Otomatis</option><option value="blue">Biru</option><option value="green">Hijau</option><option value="purple">Ungu</option><option value="orange">Oranye</option><option value="red">Merah</option></select></div></div></div>
                                <div class="md:col-span-2 mt-2"><button type="submit" id="btn-save-lms" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-all shadow-lg flex items-center justify-center"><i class="fa-solid fa-plus-circle mr-2 text-lg"></i> Simpan Materi ke Database</button></div>
                            </form>
                        </div>
                        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md border border-gray-200 dark:border-slate-700 overflow-hidden transition-colors">
                            <div class="px-6 py-4 border-b border-gray-200 dark:border-slate-700 bg-gray-50 dark:bg-slate-900 flex justify-between items-center"><h3 class="font-bold text-gray-700 dark:text-gray-200"><i class="fa-solid fa-list-check mr-2 text-blue-500"></i> Daftar Materi Terbit</h3><div class="flex gap-2"><input type="text" id="lms-search" onkeyup="renderLMSList()" placeholder="Cari..." class="text-xs px-3 py-1.5 border dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white rounded-full hidden md:block"><button onclick="fetchFromDatabase(false)" class="text-xs text-blue-500 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/30 px-3 py-1.5 rounded-full font-medium"><i class="fa-solid fa-rotate mr-1"></i> Refresh</button></div></div>
                            <div id="settings-lms-list" class="divide-y divide-gray-100 dark:divide-slate-700 max-h-[600px] overflow-y-auto custom-scrollbar bg-slate-50 dark:bg-slate-900"></div>
                        </div>
                    </div>

                    <!-- E-LIBRARY ADMIN -->
                    <div id="tab-content-lms-admin" class="hidden space-y-6">
                        <!-- Panel Konfigurasi Fitur LMS -->
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md border border-slate-200 dark:border-slate-700 mb-6 transition-colors">
                            <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2"><i class="fa-solid fa-toggle-on text-blue-600 dark:text-blue-400"></i> Konfigurasi Fitur</h3>
                            <div class="flex flex-col md:flex-row gap-4 items-end">
                                <div class="flex-1 w-full">
                                    <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Status E-Library (LMS)</label>
                                    <select id="set-lms-status" onchange="saveAppSettings(event)" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="active">Aktif (Tampil di Dashboard & Sidebar)</option>
                                        <option value="inactive">Non-Aktif (Sembunyikan)</option>
                                    </select>
                                    <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">Perubahan disimpan otomatis.</p>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md border border-slate-200 dark:border-slate-700 transition-colors">
                                <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2"><i class="fa-solid fa-cloud-arrow-up text-blue-600 dark:text-blue-400"></i> Upload Materi</h3>
                                <form id="lms-upload-form" onsubmit="handleLMSUpload(event)">
                                    <div class="mb-4">
                                        <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Kelas Tujuan</label>
                                        <select id="lms-upload-class" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border dark:border-slate-600 text-gray-800 dark:text-white rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                            <option value="" disabled selected>-- Pilih Kelas --</option>
                                        </select>
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">File PDF</label>
                                        <input type="file" id="lms-upload-file" accept="application/pdf" required class="block w-full text-sm text-slate-500 dark:text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 dark:file:bg-blue-900/30 dark:file:text-blue-400 hover:file:bg-blue-100 cursor-pointer border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700">
                                    </div>
                                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-bold transition-colors text-sm shadow-lg">Mulai Upload</button>
                                </form>
                            </div>
                            <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md border border-slate-200 dark:border-slate-700 transition-colors">
                                <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2"><i class="fa-solid fa-chalkboard-user text-green-600 dark:text-green-400"></i> Manajemen Kelas</h3>
                                <form onsubmit="handleSaveClass(event)" class="flex gap-2 mb-4">
                                    <input type="text" id="new-class-name" placeholder="Nama Kelas (Cth: X TJKT)" class="flex-1 px-3 py-2 border dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white rounded-lg text-sm focus:ring-2 focus:ring-green-500 outline-none" required>
                                    <button type="submit" class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700"><i class="fa-solid fa-plus"></i></button>
                                </form>
                                <div class="overflow-y-auto max-h-[200px] custom-scrollbar border dark:border-slate-700 rounded-lg">
                                    <table class="w-full text-sm text-left">
                                        <thead class="bg-slate-50 dark:bg-slate-900 border-b dark:border-slate-700">
                                            <tr><th class="px-4 py-2 text-xs text-slate-500 dark:text-slate-400">Nama Kelas</th><th class="px-4 py-2 text-right text-xs text-slate-500 dark:text-slate-400">Aksi</th></tr>
                                        </thead>
                                        <tbody id="class-list-body" class="divide-y divide-gray-100 dark:divide-slate-700 bg-white dark:bg-slate-800 text-gray-800 dark:text-gray-200"></tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md border border-slate-200 dark:border-slate-700 lg:col-span-3 transition-colors">
                                <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2"><i class="fa-solid fa-list-check text-purple-600 dark:text-purple-400"></i> Kelola File</h3>
                                <div class="overflow-x-auto max-h-[400px] overflow-y-auto custom-scrollbar border dark:border-slate-700 rounded-lg">
                                    <table class="w-full text-sm text-left">
                                        <thead class="text-xs text-slate-500 dark:text-slate-400 uppercase bg-slate-50 dark:bg-slate-900 border-b dark:border-slate-700 sticky top-0 shadow-sm">
                                            <tr>
                                                <th class="px-4 py-3">Nama File</th>
                                                <th class="px-4 py-3">Kelas</th>
                                                <th class="px-4 py-3 text-right">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="lms-admin-table-body" class="divide-y divide-gray-100 dark:divide-slate-700 bg-white dark:bg-slate-800 text-gray-800 dark:text-gray-200"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TAB CBT / UJIAN ADMIN -->
                    <div id="tab-content-cbt" class="hidden space-y-6 animate-fade-in">
                        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md p-6 border border-gray-200 dark:border-slate-700 transition-colors">
                            <div class="flex justify-between items-center mb-4 border-b dark:border-slate-700 pb-4">
                                <div><h3 class="text-lg font-bold text-gray-800 dark:text-white">Buat Jadwal Ujian (CBT)</h3><p class="text-sm text-gray-500 dark:text-gray-400">Tambahkan link soal (Google Form, Quizizz, Web Ujian, dll).</p></div>
                                <button onclick="resetCBTForm()" class="text-sm text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 flex items-center bg-gray-100 dark:bg-slate-700 px-3 py-1 rounded-md transition-colors"><i class="fa-solid fa-rotate-left mr-2"></i> Reset Form</button>
                            </div>
                            <form onsubmit="saveExam(event)" class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <input type="hidden" id="cbt-edit-id">
                                <div><label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1.5">Mata Pelajaran <span class="text-red-500">*</span></label><input type="text" id="cbt-subject" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-purple-500 outline-none" placeholder="Cth: Matematika" required></div>
                                <div><label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1.5">Judul Ujian <span class="text-red-500">*</span></label><input type="text" id="cbt-title" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-purple-500 outline-none" placeholder="Cth: Penilaian Akhir Semester" required></div>
                                <div><label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1.5">Kelas Tujuan <span class="text-red-500">*</span></label><select id="cbt-kelas" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-purple-500 outline-none"><option value="Semua">Semua Kelas</option></select></div>
                                <div><label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1.5">Token / Password <span class="text-gray-400 text-xs font-normal">(Opsional)</span></label><input type="text" id="cbt-token" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-purple-500 outline-none font-mono" placeholder="Kosongkan jika tidak butuh token"></div>
                                <div class="md:col-span-2"><label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1.5">Link Ujian (Google Form, dll) <span class="text-red-500">*</span></label><input type="url" id="cbt-url" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-purple-500 outline-none" placeholder="https://forms.gle/..." required></div>
                                <div><label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1.5">Waktu Mulai</label><input type="datetime-local" id="cbt-start" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white outline-none"></div>
                                <div><label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1.5">Waktu Selesai</label><input type="datetime-local" id="cbt-end" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white outline-none"></div>
                                <div><label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1.5">Status</label><select id="cbt-status" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white outline-none"><option value="active">Aktif (Terbit)</option><option value="inactive">Sembunyikan (Draf)</option></select></div>
                                
                                <div class="md:col-span-2 mt-2"><button type="submit" id="btn-save-cbt" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition-all shadow-lg flex items-center justify-center"><i class="fa-solid fa-paper-plane mr-2 text-lg"></i> Simpan Jadwal Ujian</button></div>
                            </form>
                        </div>
                        
                        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md border border-gray-200 dark:border-slate-700 overflow-hidden transition-colors">
                            <div class="px-6 py-4 border-b border-gray-200 dark:border-slate-700 bg-gray-50 dark:bg-slate-900 flex justify-between items-center"><h3 class="font-bold text-gray-700 dark:text-gray-200"><i class="fa-solid fa-list mr-2 text-purple-500"></i> Daftar Ujian Aktif</h3></div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-slate-50 dark:bg-slate-900 border-b dark:border-slate-700">
                                        <tr><th class="px-4 py-3 text-slate-500 dark:text-slate-400">Mapel / Judul</th><th class="px-4 py-3 text-slate-500 dark:text-slate-400">Kelas</th><th class="px-4 py-3 text-slate-500 dark:text-slate-400">Jadwal</th><th class="px-4 py-3 text-right text-slate-500 dark:text-slate-400">Aksi</th></tr>
                                    </thead>
                                    <tbody id="admin-cbt-list" class="divide-y divide-gray-100 dark:divide-slate-700 bg-white dark:bg-slate-800 text-gray-800 dark:text-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- TAB MENU CONTENT -->
                    <div id="tab-content-menu" class="hidden space-y-6">
                        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md p-6 border border-gray-200 dark:border-slate-700 transition-colors">
                            <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-gray-800 dark:text-white">Editor Menu Dasar</h3><button onclick="resetMenuForm()" class="text-sm text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400"><i class="fa-solid fa-rotate-left mr-1"></i> Reset</button></div>
                            <form onsubmit="saveMenu(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="hidden" id="menu-edit-id">
                                <div class="col-span-1"><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nama Menu</label><input type="text" id="menu-title" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white outline-none" placeholder="Cth: Video Pembelajaran" required></div>
                                <div class="col-span-1"><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Link URL</label><input type="text" id="menu-url" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white outline-none" placeholder="https://..." required></div>
                                <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Ikon</label><select id="menu-icon" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white outline-none"><option value="fa-desktop">Desktop</option><option value="fa-book-open">Buku</option><option value="fa-pen-to-square">Tulis</option><option value="fa-video">Video</option><option value="fa-file-pdf">Dokumen</option><option value="fa-globe">Bola Dunia</option></select></div>
                                <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Warna</label><select id="menu-color" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white outline-none"><option value="blue">Biru</option><option value="green">Hijau</option><option value="purple">Ungu</option><option value="orange">Oranye</option><option value="red">Merah</option></select></div>
                                <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label><select id="menu-status" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white outline-none"><option value="active">Aktif</option><option value="inactive">Non-Aktif</option></select></div>
                                <div class="md:col-span-1"><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Buka</label><input type="time" id="menu-auto-open" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white outline-none"></div>
                                <div class="md:col-span-1"><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tutup</label><input type="time" id="menu-auto-close" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white outline-none"></div>
                                <div class="md:col-span-2"><button type="submit" id="btn-save-menu" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors shadow"><i class="fa-solid fa-plus mr-2"></i> Simpan ke Database</button></div>
                            </form>
                        </div>
                        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md border border-gray-200 dark:border-slate-700 overflow-hidden transition-colors">
                            <div class="px-6 py-4 border-b border-gray-200 dark:border-slate-700 bg-gray-50 dark:bg-slate-900 flex justify-between items-center"><h3 class="font-bold text-gray-700 dark:text-gray-200">Daftar Menu Aktif</h3><button onclick="fetchFromDatabase(false)" class="text-xs text-blue-500 dark:text-blue-400 hover:underline"><i class="fa-solid fa-rotate mr-1"></i>Refresh Data</button></div>
                            <div id="settings-menu-list" class="divide-y divide-gray-100 dark:divide-slate-700 max-h-[500px] overflow-y-auto custom-scrollbar"></div>
                        </div>
                    </div>

                    <!-- TAB ANNOUNCEMENT CONTENT -->
                    <div id="tab-content-announcement" class="hidden space-y-6">
                        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md p-6 border border-gray-200 dark:border-slate-700 transition-colors">
                            <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4">Buat Pengumuman Baru</h3>
                            <form onsubmit="saveAnnouncement(event)" class="space-y-4">
                                <input type="hidden" id="ann-edit-id">
                                <!-- Input time disembunyikan agar otomatis -->
                                <input type="hidden" id="ann-time">
                                
                                <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Judul</label><input type="text" id="ann-title" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white outline-none" required></div>
                                <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Isi Pesan</label><textarea id="ann-content" rows="3" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white outline-none" required></textarea></div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tipe</label><select id="ann-type" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white outline-none"><option value="info">Info Umum</option><option value="warning">Peringatan</option><option value="urgent">Penting</option></select></div>
                                    <div class="flex items-end pb-2 text-sm text-gray-500 dark:text-gray-400 italic"><i class="fa-solid fa-clock mr-2"></i> Waktu akan diatur otomatis saat diterbitkan.</div>
                                </div>
                                <button type="submit" id="btn-save-ann" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors shadow"><i class="fa-solid fa-paper-plane mr-2"></i> Terbitkan ke Database</button>
                            </form>
                        </div>
                        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md border border-gray-200 dark:border-slate-700 overflow-hidden transition-colors">
                            <div class="px-6 py-4 border-b border-gray-200 dark:border-slate-700 bg-gray-50 dark:bg-slate-900"><h3 class="font-bold text-gray-700 dark:text-gray-200">Arsip Pengumuman</h3></div>
                            <div id="settings-ann-list" class="divide-y divide-gray-100 dark:divide-slate-700 max-h-[400px] overflow-y-auto custom-scrollbar"></div>
                        </div>
                    </div>

                    <!-- TAB: APP IDENTITY CONTENT -->
                    <div id="tab-content-app" class="hidden space-y-6">
                         <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md p-6 border border-gray-200 dark:border-slate-700 transition-colors">
                             <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4 flex items-center"><i class="fa-solid fa-school mr-2 text-blue-600 dark:text-blue-400"></i> Identitas Sekolah & Aplikasi</h3>
                             <form onsubmit="saveAppSettings(event)" class="space-y-5">
                                 
                                 <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Nama Aplikasi</label>
                                        <input type="text" id="set-app-name" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white outline-none focus:ring-2 focus:ring-blue-500" placeholder="Cth: NusanCBT">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Sub-Judul / Kelas</label>
                                        <input type="text" id="set-app-subtitle" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white outline-none focus:ring-2 focus:ring-blue-500" placeholder="Cth: Dashboard Siswa">
                                    </div>
                                 </div>

                                 <div>
                                     <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Running Text (Marquee)</label>
                                     <textarea id="set-running-text" rows="2" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white outline-none focus:ring-2 focus:ring-blue-500" placeholder="Pesan berjalan di atas dashboard..."></textarea>
                                 </div>

                                 <div class="border-t dark:border-slate-700 pt-5">
                                     <h4 class="text-md font-bold text-red-600 dark:text-red-400 mb-3"><i class="fa-solid fa-lock mr-2"></i> Keamanan Admin</h4>
                                     <div class="bg-red-50 dark:bg-red-900/20 p-4 rounded-lg border border-red-100 dark:border-red-800/50">
                                         <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Password Admin Baru</label>
                                         <div class="flex gap-2">
                                             <input type="text" id="set-admin-password" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white outline-none focus:ring-2 focus:ring-red-500 font-bold tracking-widest" placeholder="Masukkan password baru...">
                                             <button type="button" onclick="document.getElementById('set-admin-password').value = Math.floor(100000 + Math.random() * 900000)" class="whitespace-nowrap px-4 py-2 bg-gray-200 dark:bg-slate-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-slate-500 font-medium transition-colors">Acak PIN</button>
                                         </div>
                                     </div>
                                 </div>

                                 <div class="pt-2">
                                     <button type="submit" class="w-full bg-slate-800 dark:bg-blue-600 hover:bg-slate-900 dark:hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-all shadow-lg flex items-center justify-center">
                                         <i class="fa-solid fa-floppy-disk mr-2"></i> Simpan Pengaturan
                                     </button>
                                 </div>
                             </form>
                         </div>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <script>
        // =============================================================
        // KONFIGURASI: GANTI URL DI BAWAH INI
        // =============================================================
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwbZHbXdK9Njg4hN1qVtwR4obIDMkA6RgI948CvDIaX0rCBPhRv11Wc3MTApWm0BWkB/exec';
        // =============================================================

        // --- STATE MANAGEMENT ---
        let announcements = [];
        let menus = [];
        let classes = []; // State untuk daftar kelas
        let exams = []; // ADDED: State untuk ujian CBT
        let appSettings = {}; 
        let lastFetchedData = ""; 
        let playlistUrls = []; 
        let activeVideoIndex = 0; 
        
        // --- LMS DATA ---
        let lmsLibraryData = []; 

        // --- TASKS DATA (LOCAL) ---
        let studentTasks = JSON.parse(localStorage.getItem('student_tasks')) || [];

        // --- COLOR MAPS ---
        const gradients = { blue: 'from-blue-500 to-blue-600', green: 'from-emerald-500 to-emerald-600', purple: 'from-purple-500 to-purple-600', orange: 'from-orange-500 to-orange-600', red: 'from-red-500 to-red-600' };
        const textColors = { blue: 'text-blue-100', green: 'text-emerald-100', purple: 'text-purple-100', orange: 'text-orange-100', red: 'text-red-100' };

        // --- DOM Elements ---
        const mainIframe = document.getElementById('main-iframe');
        const playlistSidebar = document.getElementById('playlist-sidebar');
        const playlistItems = document.getElementById('playlist-items');
        const playlistCounter = document.getElementById('playlist-counter');
        const playlistToggleBtn = document.getElementById('playlist-toggle-btn');
        const playlistToggleIcon = document.getElementById('playlist-toggle-icon');
        const loader = document.getElementById('loader');
        const pageTitle = document.getElementById('page-title');
        const sidebarMenuContainer = document.getElementById('sidebar-dynamic-menu');
        const homeCardsContainer = document.getElementById('home-cards-container');
        const externalLink = document.getElementById('external-link');
        const iframeError = document.getElementById('iframe-error');
        const appLoading = document.getElementById('app-loading');
        const curfewBanner = document.getElementById('curfew-banner');

        // --- INITIALIZATION ---
        init();

        async function init() {
            initTheme(); // Inisialisasi Dark Mode
            updateClock();
            setInterval(updateClock, 1000); 
            if (GOOGLE_SCRIPT_URL.includes('GANTI_DENGAN')) {
                appLoading.innerHTML = '<div class="text-center p-4"><h3 class="text-xl font-bold text-red-600">Error Konfigurasi</h3><p>Anda belum memasukkan URL Google Script di dalam kode HTML.</p></div>';
                return;
            }
            // Fetch All Data
            await fetchFromDatabase(false); 
            fetchLMSLibrary(); 
            renderTaskList(); // Render tasks

            setInterval(() => fetchFromDatabase(true), 10000); // Sync data sheet tiap 10s
        }

        // --- DARK MODE LOGIC ---
        function initTheme() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                document.getElementById('theme-icon').className = 'fa-solid fa-sun';
            } else {
                document.documentElement.classList.remove('dark');
                document.getElementById('theme-icon').className = 'fa-solid fa-moon';
            }
        }

        function toggleDarkMode() {
            const html = document.documentElement;
            const themeIcon = document.getElementById('theme-icon');
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.theme = 'light';
                themeIcon.className = 'fa-solid fa-moon';
            } else {
                html.classList.add('dark');
                localStorage.theme = 'dark';
                themeIcon.className = 'fa-solid fa-sun';
            }
        }

        // --- CALCULATOR LOGIC ---
        function toggleCalculator() {
            const modal = document.getElementById('calculator-modal');
            modal.classList.toggle('hidden');
        }

        function calcAppend(val) {
            const display = document.getElementById('calc-display');
            if(display.value === '0') display.value = val;
            else display.value += val;
        }

        function calcClear() {
            document.getElementById('calc-display').value = '0';
        }

        function calcResult() {
            const display = document.getElementById('calc-display');
            try {
                // Gunakan eval dengan hati-hati atau ganti dengan library math
                display.value = eval(display.value) || 0;
            } catch(e) {
                display.value = 'Error';
                setTimeout(calcClear, 1000);
            }
        }

        // --- TASKS / AGENDA LOGIC (LOCAL STORAGE) ---
        function handleAddTask(e) {
            e.preventDefault();
            const subject = document.getElementById('task-subject').value;
            const title = document.getElementById('task-title').value;
            const date = document.getElementById('task-date').value;

            const newTask = {
                id: Date.now(),
                subject: subject,
                title: title,
                date: date,
                completed: false
            };

            studentTasks.unshift(newTask); // Add to top
            saveTasks();
            renderTaskList();
            e.target.reset();
            // Set default date to today again if needed
        }

        function toggleTask(id) {
            const task = studentTasks.find(t => t.id === id);
            if(task) {
                task.completed = !task.completed;
                saveTasks();
                renderTaskList();
            }
        }

        function deleteTask(id) {
            studentTasks = studentTasks.filter(t => t.id !== id);
            saveTasks();
            renderTaskList();
        }

        function clearCompletedTasks() {
            studentTasks = studentTasks.filter(t => !t.completed);
            saveTasks();
            renderTaskList();
        }

        function saveTasks() {
            localStorage.setItem('student_tasks', JSON.stringify(studentTasks));
        }

        function renderTaskList() {
            const container = document.getElementById('task-list-container');
            const statCompleted = document.getElementById('stat-completed');
            const statPending = document.getElementById('stat-pending');
            
            container.innerHTML = '';
            
            // Stats
            const completedCount = studentTasks.filter(t => t.completed).length;
            const pendingCount = studentTasks.length - completedCount;
            statCompleted.textContent = completedCount;
            statPending.textContent = pendingCount;

            if(studentTasks.length === 0) {
                container.innerHTML = `<div class="text-center py-10 text-gray-400 bg-white dark:bg-slate-800 rounded-xl border border-dashed border-gray-300 dark:border-slate-600"><i class="fa-solid fa-clipboard-check text-4xl mb-3 opacity-50"></i><p>Belum ada tugas dicatat.</p></div>`;
                return;
            }

            // Sort: Pending first, then by date
            studentTasks.sort((a, b) => {
                if(a.completed === b.completed) return new Date(a.date) - new Date(b.date);
                return a.completed ? 1 : -1;
            });

            studentTasks.forEach(task => {
                const isLate = new Date(task.date) < new Date().setHours(0,0,0,0) && !task.completed;
                const lateBadge = isLate ? `<span class="bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 text-[10px] px-2 py-0.5 rounded-full font-bold ml-2">Terlambat</span>` : '';
                
                let subjectColor = 'bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-gray-300';
                if(task.subject === 'Matematika') subjectColor = 'bg-blue-100 dark:bg-blue-900/40 text-blue-600 dark:text-blue-400';
                if(task.subject === 'Bahasa Indonesia') subjectColor = 'bg-yellow-100 dark:bg-yellow-900/40 text-yellow-700 dark:text-yellow-400';
                if(task.subject === 'IPA/Sains') subjectColor = 'bg-green-100 dark:bg-green-900/40 text-green-600 dark:text-green-400';

                container.innerHTML += `
                    <div class="task-item ${task.completed ? 'completed opacity-60 bg-gray-50 dark:bg-slate-800/50' : 'bg-white dark:bg-slate-800'} p-4 rounded-xl border border-gray-200 dark:border-slate-700 shadow-sm flex items-center justify-between group">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <button onclick="toggleTask(${task.id})" class="flex-shrink-0 w-6 h-6 rounded-full border-2 ${task.completed ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300 dark:border-slate-500 text-transparent hover:border-green-500'} flex items-center justify-center transition-colors">
                                <i class="fa-solid fa-check text-xs"></i>
                            </button>
                            <div class="min-w-0">
                                <h4 class="font-bold text-gray-800 dark:text-gray-200 text-sm truncate task-title">${task.title} ${lateBadge}</h4>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-[10px] font-bold px-2 py-0.5 rounded ${subjectColor}">${task.subject}</span>
                                    <span class="text-xs text-gray-400 dark:text-gray-500 flex items-center"><i class="fa-regular fa-calendar mr-1"></i> ${new Date(task.date).toLocaleDateString('id-ID', {day: 'numeric', month: 'short'})}</span>
                                </div>
                            </div>
                        </div>
                        <button onclick="deleteTask(${task.id})" class="text-gray-400 dark:text-gray-500 hover:text-red-500 dark:hover:text-red-400 p-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                `;
            });
        }

        // --- DATABASE FETCHING (SPREADSHEET) ---
        async function fetchFromDatabase(isBackground = false) {
            try {
                // Gunakan getTime untuk cache busting
                const response = await fetch(GOOGLE_SCRIPT_URL + '?action=read&t=' + new Date().getTime());
                const data = await response.json();
                
                if (data.status === 'success') {
                    const currentDataString = JSON.stringify(data);
                    if (currentDataString !== lastFetchedData) {
                        menus = data.menus || [];
                        announcements = data.announcements || [];
                        classes = data.classes || []; // Ambil data kelas
                        exams = data.exams || []; // Ambil jadwal ujian
                        appSettings = data.settings || {}; 
                        
                        lastFetchedData = currentDataString;
                        applyGlobalSettings();
                        refreshUI();
                        updateClassDropdowns(); // Update UI kelas
                    }
                    if (!isBackground) appLoading.classList.add('hidden');
                }
            } catch (error) {
                console.error("Error fetching data:", error);
                if (!isBackground) appLoading.classList.add('hidden');
            }
        }

        // --- LMS FETCHING (GOOGLE DRIVE) ---
        async function fetchLMSLibrary() {
            const loading = document.getElementById('lms-loading');
            const grid = document.getElementById('lms-file-grid');
            
            if(lmsLibraryData.length === 0) {
                 loading.classList.remove('hidden');
                 grid.classList.add('hidden');
            }

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getLMSLibrary' })
                });
                const result = await response.json();
                
                loading.classList.add('hidden');
                grid.classList.remove('hidden');

                if(result.status === 'success') {
                    lmsLibraryData = result.data;
                    renderLMSLibrary(lmsLibraryData);
                    // Jika tab admin terbuka, refresh juga tabel admin
                    if(!document.getElementById('tab-content-lms-admin').classList.contains('hidden')) {
                        renderLMSAdminTable();
                    }
                }
            } catch (error) {
                console.error("Error fetching LMS:", error);
                loading.classList.add('hidden');
            }
        }

        // --- SEND TO DB GENERIC ---
        async function sendToDatabase(action, payload) {
            Swal.fire({ title: 'Memproses...', allowOutsideClick: false, didOpen: () => { Swal.showLoading() } });
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: action, ...payload })
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    // Update state lokal
                    if(data.menus) menus = data.menus;
                    if(data.announcements) announcements = data.announcements;
                    if(data.exams) exams = data.exams; // Update lokal state ujian
                    if(data.classes) {
                         classes = data.classes;
                         updateClassDropdowns();
                    }
                    if(data.settings) {
                        appSettings = data.settings;
                        applyGlobalSettings(); // Langsung update UI identity
                    }

                    refreshUI();
                    Swal.fire("Berhasil", "Data berhasil disimpan!", "success");
                    return true;
                } else {
                    throw new Error(data.message || "Gagal menyimpan");
                }
            } catch (error) {
                console.error("Error saving data:", error);
                Swal.fire("Error", "Gagal: " + error.message, "error");
                return false;
            }
        }

        // --- UI UPDATERS (KELAS) ---
        function updateClassDropdowns() {
            // 1. Update Dropdown Upload
            const uploadSelect = document.getElementById('lms-upload-class');
            uploadSelect.innerHTML = '<option value="" disabled selected>-- Pilih Kelas --</option>';
            
            // CBT Class Select (Admin)
            const cbtClassSelect = document.getElementById('cbt-kelas');
            if(cbtClassSelect) cbtClassSelect.innerHTML = '<option value="Semua">Semua Kelas</option>';

            classes.forEach(c => {
                uploadSelect.innerHTML += `<option value="${c.name}">${c.name}</option>`;
                if(cbtClassSelect) cbtClassSelect.innerHTML += `<option value="${c.name}">${c.name}</option>`;
            });

            // 2. Update Filter Buttons (Student View)
            const filterContainer = document.getElementById('lms-filter-container');
            const cbtFilterContainer = document.getElementById('cbt-filter-container'); // Filter Ujian

            // Simpan tombol "Semua"
            filterContainer.innerHTML = '<button onclick="filterLMSMateri(\'Semua\')" class="filter-btn px-4 py-1.5 rounded-full text-xs font-medium bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-400 border border-blue-200 dark:border-blue-800">Semua</button>';
            if(cbtFilterContainer) cbtFilterContainer.innerHTML = '<button onclick="filterCBT(\'Semua\')" class="cbt-filter-btn px-4 py-1.5 rounded-full text-xs font-medium bg-purple-100 dark:bg-purple-900/40 text-purple-700 dark:text-purple-400 border border-purple-200 dark:border-purple-800">Semua</button>';

            classes.forEach(c => {
                filterContainer.innerHTML += `<button onclick="filterLMSMateri('${c.name}')" class="filter-btn px-4 py-1.5 rounded-full text-xs font-medium bg-white dark:bg-slate-800 text-gray-600 dark:text-gray-300 border dark:border-slate-700 hover:bg-gray-50 dark:hover:bg-slate-700">${c.name}</button>`;
                if(cbtFilterContainer) cbtFilterContainer.innerHTML += `<button onclick="filterCBT('${c.name}')" class="cbt-filter-btn px-4 py-1.5 rounded-full text-xs font-medium bg-white dark:bg-slate-800 text-gray-600 dark:text-gray-300 border dark:border-slate-700 hover:bg-gray-50 dark:hover:bg-slate-700">${c.name}</button>`;
            });

            // 3. Update Table List Kelas (Admin View)
            const tbody = document.getElementById('class-list-body');
            tbody.innerHTML = '';
            classes.forEach(c => {
                tbody.innerHTML += `
                    <tr>
                        <td class="px-4 py-2 text-slate-700 dark:text-slate-300 font-medium">${c.name}</td>
                        <td class="px-4 py-2 text-right">
                             <button onclick="handleDeleteClass('${c.id}')" class="text-red-500 hover:text-red-700 dark:hover:text-red-400 text-xs font-bold"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        }

        // --- CRUD KELAS HANDLERS ---
        function handleSaveClass(e) {
            e.preventDefault();
            const nameInput = document.getElementById('new-class-name');
            const newName = nameInput.value.trim();
            if(!newName) return;
            
            // Cek duplikat
            if(classes.some(c => c.name.toLowerCase() === newName.toLowerCase())) {
                Swal.fire('Error', 'Nama kelas sudah ada!', 'error');
                return;
            }

            const payload = {
                data: {
                    id: 'cls_' + Date.now(),
                    name: newName,
                    description: 'Kelas ' + newName
                }
            };
            sendToDatabase('saveClass', payload).then(success => {
                if(success) nameInput.value = '';
            });
        }

        function handleDeleteClass(id) {
            Swal.fire({ title: 'Hapus Kelas?', text: 'Folder di Drive tidak akan terhapus otomatis demi keamanan file.', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' })
            .then((result) => {
                if(result.isConfirmed) {
                    sendToDatabase('deleteClass', { id: id });
                }
            });
        }

        // --- APPLY GLOBAL SETTINGS ---
        function applyGlobalSettings() {
            if(appSettings.app_name) {
                document.getElementById('sidebar-app-name').textContent = appSettings.app_name;
                document.title = appSettings.app_name;
            }
            if(appSettings.app_subtitle) {
                document.getElementById('sidebar-app-subtitle').textContent = appSettings.app_subtitle;
            } else {
                 document.getElementById('sidebar-app-subtitle').textContent = "Dashboard Siswa";
            }
            
            const marqueeContainer = document.getElementById('marquee-container');
            const marqueeText = document.getElementById('marquee-text');
            if(appSettings.running_text && appSettings.running_text.trim() !== "") {
                marqueeContainer.classList.remove('hidden');
                marqueeText.textContent = appSettings.running_text;
            } else {
                marqueeContainer.classList.add('hidden');
            }

            // LMS Feature Visibility in Sidebar
            const lmsSidebarBtn = document.getElementById('btn-lms');
            if(appSettings.lms_feature_status === 'inactive') {
                lmsSidebarBtn.classList.add('hidden');
            } else {
                lmsSidebarBtn.classList.remove('hidden');
            }

            document.getElementById('set-app-name').value = appSettings.app_name || '';
            document.getElementById('set-app-subtitle').value = appSettings.app_subtitle || '';
            document.getElementById('set-running-text').value = appSettings.running_text || '';
            document.getElementById('set-admin-password').value = appSettings.admin_password || '';
            document.getElementById('set-lms-status').value = appSettings.lms_feature_status || 'active';
        }

        function saveAppSettings(e) {
            e.preventDefault();
            const newData = {
                app_name: document.getElementById('set-app-name').value,
                app_subtitle: document.getElementById('set-app-subtitle').value,
                running_text: document.getElementById('set-running-text').value,
                admin_password: document.getElementById('set-admin-password').value,
                lms_feature_status: document.getElementById('set-lms-status').value
            };
            sendToDatabase('saveSettings', { data: newData });
        }

        // --- PASSWORD VERIFICATION ---
        function verifyPassword(e) { 
            e.preventDefault(); 
            const inputPass = document.getElementById('admin-password').value;
            const target = document.getElementById('auth-target').value;
            
            const validPass = appSettings.admin_password ? String(appSettings.admin_password) : '112233';
            
            if (inputPass === validPass) { 
                closePasswordModal(); 
                executeSwitch('settings'); 
            } else { 
                Swal.fire({ icon: 'error', title: 'Akses Ditolak', text: 'Password Salah.' }); 
            } 
        }

        // --- HELPER: URL Validator ---
        function isValidUrl(string) {
            try {
                if(!string || string.trim() === '') return false;
                if(!string.match(/^https?:\/\//)) return false; 
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        function showIframeError(isInvalidFormat = false) {
             const errorDiv = document.getElementById('iframe-error');
             const errorTitle = document.getElementById('error-title');
             const errorMessage = document.getElementById('error-message');
             const errorIcon = document.getElementById('error-icon');
             
             errorDiv.classList.remove('hidden');
             loader.style.display = 'none';
             
             if(isInvalidFormat) {
                 errorTitle.textContent = "URL Tidak Valid (404)";
                 errorMessage.textContent = "Link yang Anda tuju formatnya salah atau kosong. Pastikan link dimulai dengan https://";
                 errorIcon.className = "fa-solid fa-link-slash text-4xl text-red-500";
             } else {
                 errorTitle.textContent = "Tidak Dapat Memuat Halaman";
                 errorMessage.textContent = "Website menolak ditampilkan (refused to connect) atau sedang offline.";
                 errorIcon.className = "fa-solid fa-face-frown text-4xl text-gray-400";
             }
        }

        // --- HELPER: Time Ago ---
        function timeAgo(dateParam) {
            if (!dateParam) return null;
            
            const date = new Date(dateParam);
            const now = new Date();
            
            // Fallback jika format tanggal tidak valid (misal: data lama teks manual)
            if (isNaN(date.getTime())) {
                return dateParam;
            }
            
            const seconds = Math.floor((now - date) / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (seconds < 60) return "Baru saja";
            if (minutes < 60) return `${minutes} menit yang lalu`;
            if (hours < 24) return `${hours} jam yang lalu`;
            if (days < 7) return `${days} hari yang lalu`;
            
            // Jika lebih dari seminggu, tampilkan tanggal
            return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        // --- NAVIGATION LOGIC ---
        function refreshUI() {
            renderSidebar();
            renderHome();
            renderMenuSettingsList();
            renderAnnouncementSettingsList();
            renderLMSList();
            renderAdminCBTList(); // Refresh tabel CBT admin
        }

        function switchView(viewId) {
            if (viewId === 'settings') { 
                document.getElementById('auth-target').value = 'settings';
                document.getElementById('password-modal').classList.remove('hidden'); 
                document.getElementById('admin-password').value = ''; 
                return; 
            }
            executeSwitch(viewId);
        }

        function executeSwitch(viewId) {
            document.querySelectorAll('.nav-item').forEach(el => { el.classList.remove('active', 'bg-blue-600', 'text-white'); el.classList.add('hover:bg-slate-800'); el.querySelector('i').classList.add('text-slate-400'); });
            const activeBtn = document.getElementById(`btn-${viewId}`);
            if(activeBtn) { activeBtn.classList.add('active'); activeBtn.classList.remove('hover:bg-slate-800'); activeBtn.querySelector('i').classList.remove('text-slate-400'); }
            
            if(window.innerWidth < 1024) { document.getElementById('sidebar').classList.add('-translate-x-full'); document.getElementById('mobile-overlay').classList.add('hidden'); }
            
            ['view-home', 'view-iframe-wrapper', 'view-settings', 'view-lms', 'view-tasks', 'view-cbt'].forEach(id => document.getElementById(id).classList.add('hidden'));
            mainIframe.src = ''; playlistSidebar.classList.add('hidden'); playlistToggleBtn.classList.add('hidden');
            document.getElementById('iframe-error').classList.add('hidden');

            if (viewId === 'home') { pageTitle.textContent = 'Dashboard Utama'; document.getElementById('view-home').classList.remove('hidden'); refreshUI(); }
            else if (viewId === 'settings') { pageTitle.textContent = 'Pengaturan Admin'; document.getElementById('view-settings').classList.remove('hidden'); switchSettingsTab('lms'); refreshUI(); }
            else if (viewId === 'lms') { 
                pageTitle.textContent = 'E-Library / LMS'; 
                document.getElementById('view-lms').classList.remove('hidden'); 
                renderLMSLibrary(lmsLibraryData);
            }
            else if (viewId === 'cbt') { 
                pageTitle.textContent = 'Portal Ujian (CBT)'; 
                document.getElementById('view-cbt').classList.remove('hidden'); 
                renderCBTList();
            }
            else if (viewId === 'tasks') {
                pageTitle.textContent = 'Agenda & Tugas';
                document.getElementById('view-tasks').classList.remove('hidden');
                renderTaskList();
            }
            else {
                const menuItem = menus.find(m => String(m.id) === String(viewId));
                if (menuItem) {
                    let cleanTitle = menuItem.title;
                    if(menuItem.title.includes(':')) cleanTitle = menuItem.title.split(':')[1].trim();
                    pageTitle.textContent = cleanTitle; 
                    document.getElementById('view-iframe-wrapper').classList.remove('hidden'); 
                    
                    const rawUrl = menuItem.url || "";
                    playlistUrls = rawUrl.split(',').map(u => u.trim()).filter(u => u !== "");
                    
                    if (playlistUrls.length > 1) { 
                         initPlaylist(playlistUrls); 
                    } else {
                        let finalUrl = playlistUrls[0] || "";
                        if (!isValidUrl(finalUrl)) {
                            showIframeError(true); 
                            externalLink.href = "#";
                        } else {
                            loader.style.display = 'block'; 
                            if (finalUrl.includes('youtube.com') || finalUrl.includes('youtu.be')) finalUrl = getYoutubeEmbedUrl(finalUrl);
                            
                            externalLink.href = finalUrl; 
                            mainIframe.src = finalUrl; 
                            
                            mainIframe.onload = () => loader.style.display = 'none'; 
                            mainIframe.onerror = () => { showIframeError(false); };
                        }
                    }
                }
            }
        }

        function renderLMSLibrary(data) {
            const grid = document.getElementById('lms-file-grid');
            grid.innerHTML = '';
            
            if (data.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center py-10 text-gray-400 dark:text-gray-500"><i class="fa-solid fa-folder-open text-4xl mb-2"></i><p>Belum ada materi tersedia.</p></div>`;
                return;
            }

            data.forEach(item => {
                grid.innerHTML += `
                    <div class="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 hover:shadow-md transition group relative">
                        <div class="flex justify-between mb-2">
                            <span class="bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 text-xs px-2 py-1 rounded font-bold">${item.kelas}</span>
                            <span class="text-xs text-slate-400 dark:text-slate-500">${new Date(item.date).toLocaleDateString()}</span>
                        </div>
                        <h3 class="font-bold text-slate-800 dark:text-slate-200 mb-4 line-clamp-2 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition" title="${item.name}">${item.name}</h3>
                        <div class="flex gap-2">
                            <button onclick="openPreview('${item.url}', '${item.name}')" class="flex-1 bg-slate-800 dark:bg-slate-700 text-white text-sm py-2 rounded-lg font-bold hover:bg-slate-900 dark:hover:bg-slate-600 transition-all flex items-center justify-center gap-2">
                                <i class="fa-solid fa-eye"></i> Baca
                            </button>
                            <a href="${item.downloadUrl}" target="_blank" class="px-3 py-2 border dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400 flex items-center justify-center transition-colors">
                                <i class="fa-solid fa-download"></i>
                            </a>
                        </div>
                    </div>
                `;
            });
        }

        function filterLMSMateri(category) {
            if(category === 'Semua') {
                renderLMSLibrary(lmsLibraryData);
            } else {
                const filtered = lmsLibraryData.filter(item => item.kelas === category);
                renderLMSLibrary(filtered);
            }
            const btns = document.querySelectorAll('.filter-btn');
            btns.forEach(btn => {
                if(btn.textContent === category) {
                    btn.className = "filter-btn px-4 py-1.5 rounded-full text-xs font-medium bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-400 border border-blue-200 dark:border-blue-800";
                } else {
                    btn.className = "filter-btn px-4 py-1.5 rounded-full text-xs font-medium bg-white dark:bg-slate-800 text-gray-600 dark:text-gray-300 border dark:border-slate-700 hover:bg-gray-50 dark:hover:bg-slate-700";
                }
            });
        }

        function openPreview(url, title) {
            document.getElementById('preview-title').textContent = title;
            if(!isValidUrl(url)) {
                 Swal.fire({ icon: 'error', title: 'Link Rusak', text: 'File ini tidak memiliki URL yang valid (404).' });
                 return;
            }
            document.getElementById('preview-frame').src = url;
            document.getElementById('pdf-viewer-modal').classList.remove('hidden');
        }

        function closePreview() {
            document.getElementById('pdf-viewer-modal').classList.add('hidden');
            document.getElementById('preview-frame').src = '';
        }

        // --- LMS ADMIN LOGIC (CRUD FILES) ---
        function renderLMSAdminTable() {
            const tbody = document.getElementById('lms-admin-table-body');
            tbody.innerHTML = '';
            lmsLibraryData.forEach(item => {
                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                        <td class="px-4 py-3 font-medium text-slate-700 dark:text-slate-200">${item.name}</td>
                        <td class="px-4 py-3"><span class="bg-gray-100 dark:bg-slate-600 px-2 py-1 rounded text-xs text-gray-600 dark:text-gray-300">${item.kelas}</span></td>
                        <td class="px-4 py-3 text-right">
                            <button onclick="openRenameModal('${item.id}', '${item.name}')" class="text-orange-500 hover:text-orange-700 dark:hover:text-orange-400 p-2 rounded mr-1" title="Rename"><i class="fa-solid fa-pen-to-square"></i></button>
                            <button onclick="deleteLMSFile('${item.id}')" class="text-red-600 hover:bg-red-50 dark:hover:bg-red-900/30 p-2 rounded transition-colors" title="Delete"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        }

        // --- RENAME FILE LOGIC ---
        function openRenameModal(id, currentName) {
            let cleanName = currentName.replace(/\.pdf$/i, "");
            document.getElementById('rename-file-id').value = id;
            document.getElementById('rename-file-name').value = cleanName;
            document.getElementById('rename-modal').classList.remove('hidden');
        }

        function closeRenameModal() {
            document.getElementById('rename-modal').classList.add('hidden');
        }

        function handleRenameFile(e) {
            e.preventDefault();
            const id = document.getElementById('rename-file-id').value;
            const newName = document.getElementById('rename-file-name').value.trim();

            if(!newName) return;

            closeRenameModal();
            Swal.fire({ title: 'Menyimpan...', didOpen: () => Swal.showLoading() });

            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'renameLMSFile', id: id, newName: newName })
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    Swal.fire('Sukses', 'Nama file berhasil diubah.', 'success');
                    fetchLMSLibrary();
                } else {
                    Swal.fire('Error', data.message, 'error');
                }
            })
            .catch(err => Swal.fire('Error', 'Gagal koneksi: ' + err, 'error'));
        }

        // --- UPLOAD LOGIC ---
        function handleLMSUpload(e) {
            e.preventDefault();
            const file = document.getElementById('lms-upload-file').files[0];
            const kelas = document.getElementById('lms-upload-class').value;
            
            if(!file) { Swal.fire('Error', 'Pilih file PDF!', 'warning'); return; }
            if(!kelas) { Swal.fire('Error', 'Pilih kelas tujuan!', 'warning'); return; }

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async function () {
                const base64Content = reader.result.split(',')[1]; 
                
                Swal.fire({
                    title: 'Mengupload ke Drive...',
                    text: 'Mohon tunggu...',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                try {
                    const response = await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'uploadLMSFile',
                            fileData: base64Content,
                            fileName: file.name,
                            mimeType: file.type,
                            kelas: kelas
                        })
                    });
                    const result = await response.json();

                    if (result.status === 'success') {
                        Swal.fire('Sukses', 'File berhasil diupload!', 'success');
                        document.getElementById('lms-upload-form').reset();
                        fetchLMSLibrary(); 
                    } else {
                        throw new Error(result.message);
                    }
                } catch (err) {
                    console.error(err);
                    Swal.fire('Gagal', 'Terjadi kesalahan saat upload: ' + err.message, 'error');
                }
            };
        }

        function deleteLMSFile(id) {
            Swal.fire({ title: 'Hapus file ini?', text: 'File akan dipindah ke sampah Google Drive', icon: 'warning', showCancelButton: true, confirmButtonText: 'Ya, Hapus', confirmButtonColor: '#d33' })
            .then(async (result) => {
                if (result.isConfirmed) {
                    Swal.fire({ title: 'Menghapus...', didOpen: () => Swal.showLoading() });
                    try {
                        const response = await fetch(GOOGLE_SCRIPT_URL, {
                            method: 'POST',
                            body: JSON.stringify({ action: 'deleteLMSFile', id: id })
                        });
                        const resData = await response.json();
                        
                        if(resData.status === 'success') {
                            Swal.fire('Terhapus', 'File berhasil dihapus.', 'success');
                            fetchLMSLibrary(); // Refresh
                        } else {
                            throw new Error(resData.message);
                        }
                    } catch(err) {
                         Swal.fire('Gagal', 'Tidak dapat menghapus file: ' + err.message, 'error');
                    }
                }
            });
        }

        // --- STANDARD UTILS ---
        function getMenuTimeStatus(menu) {
            const manualStatus = menu.status ? menu.status.toString().toLowerCase() : 'active';
            if (manualStatus === 'inactive') return { code: 'manual_inactive', label: 'Non-Aktif', color: 'gray', isActive: false };

            const now = new Date();
            const currentTotalMinutes = (now.getHours() * 60) + now.getMinutes();
            const timeToMinutes = (timeStr) => {
                if (!timeStr || typeof timeStr !== 'string' || !timeStr.includes(':')) return null;
                const [h, m] = timeStr.split(':').map(Number);
                if (isNaN(h) || isNaN(m)) return null; 
                return (h * 60) + m;
            };

            if (menu.auto_open && menu.auto_open.trim() !== "") {
                const openMins = timeToMinutes(menu.auto_open);
                if (openMins !== null && currentTotalMinutes < openMins) return { code: 'not_open_yet', label: `Buka ${menu.auto_open}`, color: 'yellow', isActive: false };
            }

            if (menu.auto_close && menu.auto_close.trim() !== "") {
                const closeMins = timeToMinutes(menu.auto_close);
                if (closeMins !== null && currentTotalMinutes >= closeMins) return { code: 'closed', label: `Tutup ${menu.auto_close}`, color: 'red', isActive: false };
            }
            return { code: 'active', label: 'Aktif', color: 'green', isActive: true };
        }

        function getYoutubeEmbedUrl(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? 'https://www.youtube.com/embed/' + match[2] + '?autoplay=1&rel=0' : url;
        }

        function getYoutubeThumbnail(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? `https://img.youtube.com/vi/${match[2]}/mqdefault.jpg` : 'https://via.placeholder.com/120x90?text=Video';
        }

        function renderSidebar() {
            sidebarMenuContainer.innerHTML = '';
            menus.forEach(menu => {
                const statusObj = getMenuTimeStatus(menu);
                if (!statusObj.isActive) return;
                const btn = document.createElement('button');
                btn.id = `btn-${menu.id}`;
                btn.className = 'nav-item w-full flex items-center gap-3 px-3 py-3 rounded-lg hover:bg-slate-800 transition-colors';
                btn.onclick = () => switchView(menu.id);
                btn.innerHTML = `<i class="fa-solid ${menu.icon} w-5 text-center text-slate-400 transition-colors"></i><span class="text-sm font-medium text-left truncate">${menu.title}</span>`;
                sidebarMenuContainer.appendChild(btn);
            });
        }

        function renderHome() {
            homeCardsContainer.innerHTML = '';
            
            // 1. Render LMS Card jika setting active (Ditaruh paling awal)
            if (appSettings.lms_feature_status !== 'inactive') {
                const lmsCard = document.createElement('div');
                // Menggunakan warna khusus (Indigo) agar terlihat seperti fitur premium/spesial
                lmsCard.className = `bg-gradient-to-br from-indigo-600 to-blue-700 dark:from-indigo-800 dark:to-blue-900 rounded-xl p-6 text-white shadow-lg cursor-pointer transform hover:scale-105 transition-transform flex flex-col h-full border border-indigo-500 dark:border-indigo-700`;
                lmsCard.onclick = () => switchView('lms');
                lmsCard.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="bg-white/20 p-3 rounded-lg flex-shrink-0 backdrop-blur-sm">
                            <i class="fa-solid fa-book-open text-2xl"></i>
                        </div>
                        <div class="bg-black/20 px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider">Perpustakaan</div>
                    </div>
                    <div class="mt-auto">
                        <p class="text-indigo-100 dark:text-indigo-300 text-xs font-bold uppercase tracking-wider mb-1 opacity-80">E-Library</p>
                        <h3 class="text-lg font-bold leading-tight line-clamp-2">Akses Materi & E-Book</h3>
                    </div>
                    <div class="mt-4 flex items-center text-xs opacity-75">
                        <span><i class="fa-solid fa-arrow-right mr-1"></i> Buka Pustaka</span>
                    </div>`;
                homeCardsContainer.appendChild(lmsCard);
            }

            // 2. Render Menu Dinamis Lainnya
            let timeRestrictedCount = 0;
            menus.forEach(menu => {
                const statusObj = getMenuTimeStatus(menu);
                if (!statusObj.isActive) {
                    if (statusObj.code === 'not_open_yet' || statusObj.code === 'closed') timeRestrictedCount++;
                    return; 
                }
                const gradient = gradients[menu.color] || gradients.blue;
                const textColor = textColors[menu.color] || textColors.blue;
                let displayTitle = menu.title, displaySubtitle = "Menu Utama", tag = "";
                if(menu.title.includes(":")) {
                    const parts = menu.title.split(":");
                    if(parts.length >= 2) { displaySubtitle = parts[0].trim(); displayTitle = parts.slice(1).join(":").trim(); tag = `<span class="ml-2 text-[10px] bg-white/20 px-1.5 py-0.5 rounded text-white opacity-80">${displaySubtitle}</span>`; }
                }
                const card = document.createElement('div');
                card.className = `bg-gradient-to-br ${gradient} rounded-xl p-6 text-white shadow-lg cursor-pointer transform hover:scale-105 transition-transform flex flex-col h-full`;
                card.onclick = () => switchView(menu.id);
                card.innerHTML = `<div class="flex justify-between items-start mb-4"><div class="bg-white/20 p-3 rounded-lg flex-shrink-0 backdrop-blur-sm"><i class="fa-solid ${menu.icon} text-2xl"></i></div>${tag ? `<div class="bg-black/10 px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider">${displaySubtitle}</div>` : ''}</div><div class="mt-auto"><p class="${textColor} text-xs font-bold uppercase tracking-wider mb-1 opacity-80">${!tag ? displaySubtitle : 'Materi Pembelajaran'}</p><h3 class="text-lg font-bold leading-tight line-clamp-2">${displayTitle}</h3></div><div class="mt-4 flex items-center text-xs opacity-75"><span><i class="fa-solid fa-arrow-right mr-1"></i> Buka Materi</span></div>`;
                homeCardsContainer.appendChild(card);
            });
            curfewBanner.classList.toggle('hidden', timeRestrictedCount === 0);
            
            const annList = document.getElementById('announcement-list');
            annList.innerHTML = '';
            if(announcements.length === 0) annList.innerHTML = '<div class="text-center text-gray-500 py-4">Belum ada pengumuman.</div>';
            announcements.forEach(item => {
                let colorClass = 'bg-blue-100 text-blue-600 dark:bg-blue-900/40 dark:text-blue-400', icon = 'fa-bullhorn';
                if (item.type === 'warning') { colorClass = 'bg-orange-100 text-orange-600 dark:bg-orange-900/40 dark:text-orange-400'; icon = 'fa-triangle-exclamation'; }
                if (item.type === 'urgent') { colorClass = 'bg-red-100 text-red-600 dark:bg-red-900/40 dark:text-red-400'; icon = 'fa-circle-exclamation'; }
                const div = document.createElement('div');
                div.className = 'flex gap-4 items-start p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors';
                div.innerHTML = `<div class="w-12 h-12 rounded-full ${colorClass} flex items-center justify-center flex-shrink-0"><i class="fa-solid ${icon}"></i></div><div><h4 class="font-semibold text-gray-800 dark:text-white">${item.title}</h4><p class="text-sm text-gray-600 dark:text-gray-300 mt-1">${item.content}</p><span class="text-xs text-gray-400 mt-2 block"><i class="fa-regular fa-clock mr-1"></i> ${timeAgo(item.time)}</span></div>`;
                annList.appendChild(div);
            });
        }

        function togglePlaylist() {
            const sidebar = document.getElementById('playlist-sidebar');
            const icon = document.getElementById('playlist-toggle-icon');
            if (sidebar.classList.contains('hidden')) { sidebar.classList.remove('hidden'); icon.classList.remove('fa-expand'); icon.classList.add('fa-list'); } 
            else { sidebar.classList.add('hidden'); icon.classList.remove('fa-list'); icon.classList.add('fa-expand'); }
        }

        function initPlaylist(urls) {
            playlistSidebar.classList.remove('hidden'); playlistToggleBtn.classList.remove('hidden');
            const icon = document.getElementById('playlist-toggle-icon'); icon.classList.remove('fa-expand'); icon.classList.add('fa-list');
            playlistItems.innerHTML = ''; activeVideoIndex = 0; playlistCounter.textContent = `1/${urls.length}`;
            urls.forEach((url, index) => {
                let thumbnail = 'https://via.placeholder.com/120x90?text=Video';
                if (url.includes('youtube.com') || url.includes('youtu.be')) thumbnail = getYoutubeThumbnail(url);
                const item = document.createElement('div');
                item.className = `playlist-item cursor-pointer p-3 flex gap-3 items-center border-b border-gray-100 dark:border-slate-700 ${index === 0 ? 'active' : ''}`;
                item.onclick = () => loadPlaylistVideo(index);
                item.innerHTML = `<div class="relative w-24 h-16 bg-gray-200 dark:bg-slate-700 rounded overflow-hidden flex-shrink-0 group"><img src="${thumbnail}" class="w-full h-full object-cover transition-transform group-hover:scale-110"><div class="absolute inset-0 bg-black/20 group-hover:bg-black/10 flex items-center justify-center transition-colors icon-play opacity-0 group-hover:opacity-100"><i class="fa-solid fa-play text-white drop-shadow-md text-sm"></i></div></div><div class="flex-1 min-w-0"><p class="text-sm text-gray-700 dark:text-gray-200 truncate title">Materi Bagian ${index + 1}</p><p class="text-[10px] text-gray-400 mt-1 uppercase tracking-wide">Video Pembelajaran</p></div>`;
                playlistItems.appendChild(item);
            });
            loadPlaylistVideo(0); 
        }

        function loadPlaylistVideo(index) {
            activeVideoIndex = index;
            let url = playlistUrls[index];
            document.querySelectorAll('.playlist-item').forEach((btn, idx) => { if (idx === index) btn.classList.add('active'); else btn.classList.remove('active'); });
            playlistCounter.textContent = `${index + 1}/${playlistUrls.length}`;
            if (window.innerWidth < 768) togglePlaylist(); 
            
            document.getElementById('iframe-error').classList.add('hidden'); // Reset error
            if (!isValidUrl(url)) {
                 showIframeError(true);
                 externalLink.href = "#";
                 loader.style.display = 'none';
                 return;
            }

            loader.style.display = 'block';
            if (url.includes('youtube.com') || url.includes('youtu.be')) url = getYoutubeEmbedUrl(url);
            mainIframe.src = url; externalLink.href = playlistUrls[index]; 
            mainIframe.onload = () => loader.style.display = 'none';
            mainIframe.onerror = () => { showIframeError(false); };
        }

        function closePasswordModal() { document.getElementById('password-modal').classList.add('hidden'); }
        
        function switchSettingsTab(tabName) { 
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); 
            document.getElementById(`tab-btn-${tabName}`).classList.add('active'); 
            // Sembunyikan semua konten tab di settings
            ['tab-content-menu', 'tab-content-announcement', 'tab-content-lms', 'tab-content-app', 'tab-content-lms-admin', 'tab-content-cbt'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.add('hidden');
            });
            
            // Tampilkan tab yang dipilih
            const targetContent = document.getElementById(`tab-content-${tabName}`);
            if(targetContent) targetContent.classList.remove('hidden');

            // Khusus tab admin E-Library, refresh tabelnya
            if (tabName === 'lms-admin') {
                renderLMSAdminTable();
                updateClassDropdowns();
            }
            // Khusus tab admin CBT
            if (tabName === 'cbt') {
                renderAdminCBTList();
            }
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('-translate-x-full'); document.getElementById('mobile-overlay').classList.toggle('hidden'); }
        function toggleFullscreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else if (document.exitFullscreen) document.exitFullscreen(); }
        function updateClock() { const now = new Date(); document.getElementById('digital-clock').textContent = now.toLocaleTimeString('id-ID', { hour12: false }); document.getElementById('current-date').textContent = now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' }); }

        function renderLMSList() {
            const list = document.getElementById('settings-lms-list'); const search = document.getElementById('lms-search').value.toLowerCase(); list.innerHTML = '';
            const lmsItems = menus.filter(m => m.title.includes(':') || m.id.startsWith('lms_'));
            if(lmsItems.length === 0) { list.innerHTML = '<div class="p-8 text-center text-gray-400 dark:text-gray-500"><p>Belum ada materi.</p></div>'; return; }
            lmsItems.forEach(menu => {
                if (search && !menu.title.toLowerCase().includes(search)) return;
                const parts = menu.title.includes(':') ? menu.title.split(':') : ['Umum', menu.title];
                const statusObj = getMenuTimeStatus(menu);
                let statusColor = statusObj.isActive ? 'text-green-600 bg-green-50 dark:bg-green-900/30 dark:text-green-400' : 'text-gray-500 bg-gray-100 dark:bg-gray-700 dark:text-gray-300';
                list.innerHTML += `<div class="p-4 flex justify-between items-center hover:bg-white dark:hover:bg-slate-800 transition-colors gap-3 border-b dark:border-slate-700"><div class="flex items-start gap-3 w-full"><div class="w-10 h-10 rounded-lg bg-${menu.color}-100 dark:bg-${menu.color}-900/30 flex items-center justify-center text-${menu.color}-600 dark:text-${menu.color}-400 flex-shrink-0 mt-1"><i class="fa-solid ${menu.icon}"></i></div><div class="min-w-0"><div class="flex items-center gap-2 mb-0.5"><span class="text-[10px] font-bold uppercase tracking-wider px-1.5 py-0.5 rounded bg-gray-200 dark:bg-slate-700 text-gray-600 dark:text-gray-300">${parts[0].trim()}</span><span class="text-[10px] px-1.5 py-0.5 rounded ${statusColor}">${statusObj.label}</span></div><h4 class="font-bold text-gray-800 dark:text-gray-200 text-sm truncate">${parts.slice(1).join(':').trim()}</h4><p class="text-xs text-gray-400 dark:text-gray-500 truncate max-w-[200px]">${menu.url}</p></div></div><div class="flex gap-2"><button onclick="editLMS('${menu.id}')" class="px-3 py-1.5 bg-yellow-50 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-500 rounded-lg text-xs font-medium border border-yellow-200 dark:border-yellow-800/50">Edit</button><button onclick="deleteMenu('${menu.id}')" class="px-3 py-1.5 bg-red-50 dark:bg-red-900/30 text-red-700 dark:text-red-500 rounded-lg text-xs font-medium border border-red-200 dark:border-red-800/50">Hapus</button></div></div>`;
            });
        }

        function renderMenuSettingsList() {
            const list = document.getElementById('settings-menu-list'); list.innerHTML = '';
            const basicMenus = menus.filter(m => !m.title.includes(':') && !m.id.startsWith('lms_'));
            basicMenus.forEach(menu => {
                const statusObj = getMenuTimeStatus(menu);
                let statusBadge = statusObj.isActive ? '<span class="px-2 py-1 text-xs rounded-full bg-green-100 dark:bg-green-900/40 text-green-700 dark:text-green-400 font-bold">Aktif</span>' : '<span class="px-2 py-1 text-xs rounded-full bg-gray-200 dark:bg-slate-700 text-gray-600 dark:text-gray-300">Non-Aktif</span>';
                list.innerHTML += `<div class="p-4 flex justify-between items-center hover:bg-gray-50 dark:hover:bg-slate-800 gap-4 transition-colors border-b dark:border-slate-700"><div class="flex items-center gap-4 w-full"><div class="w-10 h-10 rounded bg-gray-100 dark:bg-slate-700 flex items-center justify-center text-gray-600 dark:text-gray-300 flex-shrink-0"><i class="fa-solid ${menu.icon}"></i></div><div class="min-w-0"><h4 class="font-bold text-gray-800 dark:text-white truncate">${menu.title}</h4>${statusBadge}</div></div><div class="flex gap-2 shrink-0"><button onclick="editMenu('${menu.id}')" class="px-3 py-1.5 bg-yellow-100 dark:bg-yellow-900/40 text-yellow-700 dark:text-yellow-400 rounded text-sm font-medium">Edit</button><button onclick="deleteMenu('${menu.id}')" class="px-3 py-1.5 bg-red-100 dark:bg-red-900/40 text-red-700 dark:text-red-400 rounded text-sm font-medium">Hapus</button></div></div>`;
            });
        }

        function renderAnnouncementSettingsList() {
            const list = document.getElementById('settings-ann-list'); list.innerHTML = '';
            announcements.forEach(item => { list.innerHTML += `<div class="p-4 flex justify-between items-center hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors"><div class="mb-2 md:mb-0 w-full"><div class="flex items-center gap-2 mb-1"><span class="px-2 py-0.5 rounded text-xs font-bold uppercase bg-gray-200 dark:bg-slate-600 text-gray-700 dark:text-gray-300">${item.type}</span><h4 class="font-bold text-gray-800 dark:text-white">${item.title}</h4></div><p class="text-sm text-gray-600 dark:text-gray-400 truncate max-w-xs">${item.content}</p></div><div class="flex gap-2"><button onclick="editAnnouncement(${item.id})" class="text-yellow-600 dark:text-yellow-400 p-2"><i class="fa-solid fa-pen"></i></button><button onclick="deleteAnnouncement(${item.id})" class="text-red-600 dark:text-red-400 p-2"><i class="fa-solid fa-trash"></i></button></div></div>`; });
        }

        function editMenu(id) {
            const item = menus.find(m => String(m.id) === String(id));
            if(item) { switchSettingsTab('menu'); document.getElementById('menu-edit-id').value = item.id; document.getElementById('menu-title').value = item.title; document.getElementById('menu-url').value = item.url; document.getElementById('menu-icon').value = item.icon; document.getElementById('menu-color').value = item.color; document.getElementById('menu-status').value = item.status; document.getElementById('menu-auto-close').value = item.auto_close; document.getElementById('menu-auto-open').value = item.auto_open; document.getElementById('btn-save-menu').innerHTML = 'Update Menu'; }
        }
        
        function editLMS(id) {
            const item = menus.find(m => String(m.id) === String(id));
            if(item) {
                switchSettingsTab('lms'); document.getElementById('lms-edit-id').value = item.id;
                let mapel = "Umum", topic = item.title;
                if(item.title.includes(":")) { const parts = item.title.split(":"); mapel = parts[0].trim(); topic = parts.slice(1).join(":").trim(); }
                document.getElementById('lms-subject').value = mapel; document.getElementById('lms-topic').value = topic; document.getElementById('lms-url').value = item.url;
                document.getElementById('lms-status').value = item.status; document.getElementById('lms-auto-close').value = item.auto_close; document.getElementById('lms-auto-open').value = item.auto_open;
                document.getElementById('btn-save-lms').innerHTML = 'Update Materi';
            }
        }

        function resetMenuForm() { document.getElementById('menu-edit-id').value = ''; document.getElementById('menu-title').value = ''; document.getElementById('menu-url').value = ''; document.getElementById('menu-status').value = 'active'; document.getElementById('menu-auto-close').value = ''; document.getElementById('menu-auto-open').value = ''; document.getElementById('btn-save-menu').innerHTML = '<i class="fa-solid fa-plus mr-2"></i> Simpan ke Database'; }
        function resetLMSForm() { document.getElementById('lms-edit-id').value = ''; document.getElementById('lms-subject').value = ''; document.getElementById('lms-topic').value = ''; document.getElementById('lms-url').value = ''; document.getElementById('lms-status').value = 'active'; document.getElementById('lms-auto-close').value = ''; document.getElementById('lms-auto-open').value = ''; document.getElementById('btn-save-lms').innerHTML = '<i class="fa-solid fa-plus-circle mr-2 text-lg"></i> Simpan Materi ke Database'; }

        // ==========================================
        // FITUR CBT & EXAM LOGIC
        // ==========================================
        
        function getExamStatus(exam) {
            if(exam.status === 'inactive') return { label: 'Draf', type: 'draft' };
            const now = new Date();
            const start = exam.start_date ? new Date(exam.start_date) : null;
            const end = exam.end_date ? new Date(exam.end_date) : null;
            
            if (start && now < start) return { label: 'Belum Dimulai', type: 'pending' };
            if (end && now > end) return { label: 'Berakhir', type: 'closed' };
            return { label: 'Sedang Berlangsung', type: 'active' };
        }

        function renderCBTList(filterClass = 'Semua') {
            const grid = document.getElementById('cbt-exam-grid');
            if(!grid) return;
            grid.innerHTML = '';
            
            // Filter Active and by Class
            const availableExams = exams.filter(e => {
                if(e.status === 'inactive') return false;
                if(filterClass !== 'Semua' && e.kelas !== 'Semua' && e.kelas !== filterClass) return false;
                return true;
            });

            if (availableExams.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center py-10 text-gray-400 dark:text-gray-500"><i class="fa-solid fa-laptop-code text-4xl mb-3 opacity-50"></i><p>Tidak ada jadwal ujian untuk kelas ini saat ini.</p></div>`;
                return;
            }

            availableExams.forEach(exam => {
                const status = getExamStatus(exam);
                
                let badgeClass = 'bg-gray-100 text-gray-600 dark:bg-slate-700 dark:text-gray-300';
                let btnHtml = `<button disabled class="w-full mt-4 py-2 rounded-lg bg-gray-100 dark:bg-slate-700 text-gray-400 dark:text-gray-500 font-bold cursor-not-allowed border border-gray-200 dark:border-slate-600">Belum Tersedia</button>`;
                
                if(status.type === 'active') {
                    badgeClass = 'bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-400 animate-pulse';
                    const icon = exam.token ? '<i class="fa-solid fa-lock mr-1"></i> ' : '';
                    btnHtml = `<button onclick="openExam('${exam.id}')" class="w-full mt-4 py-2 rounded-lg bg-purple-600 hover:bg-purple-700 text-white font-bold transition-colors shadow-md">${icon}Mulai Ujian</button>`;
                } else if (status.type === 'closed') {
                    badgeClass = 'bg-red-100 text-red-700 dark:bg-red-900/40 dark:text-red-400';
                    btnHtml = `<button disabled class="w-full mt-4 py-2 rounded-lg bg-red-50 dark:bg-red-900/20 text-red-400 dark:text-red-500 font-bold cursor-not-allowed border border-red-100 dark:border-red-900/30">Ditutup</button>`;
                } else if (status.type === 'pending') {
                    badgeClass = 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/40 dark:text-yellow-400';
                }

                const startDateStr = exam.start_date ? new Date(exam.start_date).toLocaleString('id-ID', {day: 'numeric', month: 'short', hour:'2-digit', minute:'2-digit'}) : '-';
                const endDateStr = exam.end_date ? new Date(exam.end_date).toLocaleString('id-ID', {day: 'numeric', month: 'short', hour:'2-digit', minute:'2-digit'}) : '-';

                grid.innerHTML += `
                    <div class="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 flex flex-col h-full hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-3">
                            <span class="text-xs font-bold px-2 py-1 rounded bg-purple-50 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 border border-purple-100 dark:border-purple-800/50">${exam.kelas}</span>
                            <span class="text-[10px] font-bold px-2 py-1 rounded ${badgeClass}">${status.label}</span>
                        </div>
                        <h3 class="font-bold text-lg text-slate-800 dark:text-white mb-1 line-clamp-2">${exam.title}</h3>
                        <p class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-4">${exam.subject}</p>
                        
                        <div class="mt-auto space-y-2 text-xs text-slate-600 dark:text-slate-400 bg-slate-50 dark:bg-slate-900/50 p-3 rounded-lg border border-slate-100 dark:border-slate-700">
                            <div class="flex justify-between"><span><i class="fa-regular fa-clock mr-1"></i> Mulai</span> <span class="font-medium">${startDateStr}</span></div>
                            <div class="flex justify-between"><span><i class="fa-regular fa-clock mr-1"></i> Selesai</span> <span class="font-medium">${endDateStr}</span></div>
                            ${exam.token ? `<div class="flex justify-between text-purple-600 dark:text-purple-400 mt-1 pt-1 border-t border-purple-100 dark:border-slate-700"><span><i class="fa-solid fa-shield-halved mr-1"></i> Status Akses</span> <span class="font-bold">Butuh Token</span></div>` : ''}
                        </div>
                        
                        ${btnHtml}
                    </div>
                `;
            });
        }

        function filterCBT(kelas) {
            renderCBTList(kelas);
            const btns = document.querySelectorAll('.cbt-filter-btn');
            btns.forEach(btn => {
                if(btn.textContent === kelas) {
                    btn.className = "cbt-filter-btn px-4 py-1.5 rounded-full text-xs font-medium bg-purple-100 dark:bg-purple-900/40 text-purple-700 dark:text-purple-400 border border-purple-200 dark:border-purple-800";
                } else {
                    btn.className = "cbt-filter-btn px-4 py-1.5 rounded-full text-xs font-medium bg-white dark:bg-slate-800 text-gray-600 dark:text-gray-300 border dark:border-slate-700 hover:bg-gray-50 dark:hover:bg-slate-700";
                }
            });
        }

        function openExam(id) {
            const exam = exams.find(e => String(e.id) === String(id));
            if(!exam) return;

            if(!isValidUrl(exam.url)) {
                 Swal.fire({ icon: 'error', title: 'URL Tidak Valid', text: 'Link ujian rusak atau formatnya salah (Wajib dimulai dengan http/https).' });
                 return;
            }

            if(exam.token && exam.token.trim() !== '') {
                Swal.fire({
                    title: 'Verifikasi Token',
                    text: 'Masukkan token ujian yang diberikan oleh guru pengawas.',
                    input: 'text',
                    inputAttributes: { autocapitalize: 'off', placeholder: 'Ketik token disini...' },
                    showCancelButton: true,
                    confirmButtonText: 'Verifikasi & Masuk',
                    confirmButtonColor: '#9333ea',
                    cancelButtonText: 'Batal',
                    preConfirm: (token) => {
                        if (token !== exam.token.trim()) {
                            Swal.showValidationMessage(`Token yang Anda masukkan salah.`);
                        }
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        launchExamIframe(exam);
                    }
                });
            } else {
                launchExamIframe(exam);
            }
        }

        function launchExamIframe(exam) {
            document.querySelectorAll('.nav-item').forEach(el => { el.classList.remove('active', 'bg-blue-600', 'text-white'); el.classList.add('hover:bg-slate-800'); el.querySelector('i').classList.add('text-slate-400'); });
            ['view-home', 'view-settings', 'view-lms', 'view-tasks', 'view-cbt'].forEach(id => document.getElementById(id).classList.add('hidden'));
            
            pageTitle.textContent = "UJIAN CBT: " + exam.title; 
            document.getElementById('view-iframe-wrapper').classList.remove('hidden'); 
            playlistSidebar.classList.add('hidden'); 
            playlistToggleBtn.classList.add('hidden');
            
            loader.style.display = 'block'; 
            externalLink.href = exam.url; 
            mainIframe.src = exam.url; 
            
            mainIframe.onload = () => loader.style.display = 'none'; 
            mainIframe.onerror = () => { showIframeError(false); };
        }

        // --- CBT ADMIN LOGIC ---
        function resetCBTForm() {
            document.getElementById('cbt-edit-id').value = '';
            document.getElementById('cbt-subject').value = '';
            document.getElementById('cbt-title').value = '';
            document.getElementById('cbt-kelas').value = 'Semua';
            document.getElementById('cbt-token').value = '';
            document.getElementById('cbt-url').value = '';
            document.getElementById('cbt-start').value = '';
            document.getElementById('cbt-end').value = '';
            document.getElementById('cbt-status').value = 'active';
            document.getElementById('btn-save-cbt').innerHTML = '<i class="fa-solid fa-paper-plane mr-2 text-lg"></i> Simpan Jadwal Ujian';
        }

        function saveExam(e) {
            e.preventDefault();
            const data = {
                id: document.getElementById('cbt-edit-id').value || 'exam_' + Date.now(),
                subject: document.getElementById('cbt-subject').value.trim(),
                title: document.getElementById('cbt-title').value.trim(),
                kelas: document.getElementById('cbt-kelas').value,
                token: document.getElementById('cbt-token').value.trim(),
                url: document.getElementById('cbt-url').value.trim(),
                start_date: document.getElementById('cbt-start').value,
                end_date: document.getElementById('cbt-end').value,
                status: document.getElementById('cbt-status').value
            };
            sendToDatabase('saveExam', { data: data }).then(success => {
                if(success) { resetCBTForm(); renderAdminCBTList(); }
            });
        }

        function renderAdminCBTList() {
            const list = document.getElementById('admin-cbt-list');
            if(!list) return;
            list.innerHTML = '';
            
            if(exams.length === 0) {
                list.innerHTML = `<tr><td colspan="4" class="px-4 py-6 text-center text-gray-400 dark:text-gray-500">Belum ada jadwal ujian yang dibuat.</td></tr>`;
                return;
            }

            exams.forEach(exam => {
                let badge = `<span class="px-2 py-0.5 text-[10px] font-bold rounded-full ${exam.status === 'active' ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' : 'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300'}">${exam.status === 'active' ? 'Aktif' : 'Draf'}</span>`;
                
                list.innerHTML += `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors border-b dark:border-slate-700">
                        <td class="px-4 py-3">
                            <div class="font-bold text-slate-800 dark:text-white">${exam.title}</div>
                            <div class="text-xs text-slate-500 dark:text-slate-400 mt-1">${exam.subject} ${badge}</div>
                        </td>
                        <td class="px-4 py-3">
                            <span class="bg-purple-50 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 px-2 py-1 rounded text-xs font-bold border border-purple-100 dark:border-purple-800/50">${exam.kelas}</span>
                            ${exam.token ? `<div class="text-[10px] text-gray-400 dark:text-gray-500 mt-2 font-mono"><i class="fa-solid fa-key"></i> ${exam.token}</div>` : ''}
                        </td>
                        <td class="px-4 py-3 text-xs text-slate-600 dark:text-slate-400 space-y-1">
                            <div><span class="font-semibold text-slate-400 dark:text-slate-500">Mulai:</span> ${exam.start_date ? new Date(exam.start_date).toLocaleString('id-ID', {day: 'numeric', month: 'short', hour:'2-digit', minute:'2-digit'}) : '-'}</div>
                            <div><span class="font-semibold text-slate-400 dark:text-slate-500">Akhir:</span> ${exam.end_date ? new Date(exam.end_date).toLocaleString('id-ID', {day: 'numeric', month: 'short', hour:'2-digit', minute:'2-digit'}) : '-'}</div>
                        </td>
                        <td class="px-4 py-3 text-right whitespace-nowrap">
                            <button onclick="editExam('${exam.id}')" class="text-yellow-600 hover:bg-yellow-50 dark:text-yellow-500 dark:hover:bg-yellow-900/30 p-2 rounded transition-colors" title="Edit Jadwal"><i class="fa-solid fa-pen-to-square"></i></button>
                            <button onclick="deleteExam('${exam.id}')" class="text-red-600 hover:bg-red-50 dark:text-red-500 dark:hover:bg-red-900/30 p-2 rounded transition-colors" title="Hapus"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        }

        function editExam(id) {
            const item = exams.find(e => String(e.id) === String(id));
            if(item) {
                document.getElementById('cbt-edit-id').value = item.id;
                document.getElementById('cbt-subject').value = item.subject || '';
                document.getElementById('cbt-title').value = item.title || '';
                document.getElementById('cbt-kelas').value = item.kelas || 'Semua';
                document.getElementById('cbt-token').value = item.token || '';
                document.getElementById('cbt-url').value = item.url || '';
                document.getElementById('cbt-start').value = item.start_date || '';
                document.getElementById('cbt-end').value = item.end_date || '';
                document.getElementById('cbt-status').value = item.status || 'active';
                document.getElementById('btn-save-cbt').innerHTML = '<i class="fa-solid fa-pen mr-2"></i> Update Jadwal Ujian';
                // Scroll up gently
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function deleteExam(id) { 
            Swal.fire({ title: 'Hapus Jadwal Ujian?', text: 'Jadwal ini akan hilang dari aplikasi siswa selamanya.', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya, Hapus' })
            .then((r) => { 
                if (r.isConfirmed) sendToDatabase('deleteExam', { id: id }).then(success => { if(success) renderAdminCBTList(); }); 
            }); 
        }

    </script>
</body>
</html>
